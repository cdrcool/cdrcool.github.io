<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="OnePiece">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="OnePiece">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="晴天">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>OnePiece</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">OnePiece</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">人的知识就好比一个圆圈，圆圈里面是已知的，圆圈外面是未知的。你知道得越多，圆圈也就越大，你不知道的也就越多。</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/29/Spring%20Cloud%20Consul%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/29/Spring%20Cloud%20Consul%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">Spring Cloud Consul 开发实践</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-29 11:13:00" itemprop="dateCreated datePublished" datetime="2020-02-29T11:13:00+08:00">2020-02-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><h3 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 服务注册与发现 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置属性"><a href="#配置属性" class="headerlink" title="配置属性"></a>配置属性</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">account</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">loadbalancer:</span></span><br><span class="line">      <span class="attr">ribbon:</span></span><br><span class="line">        <span class="comment"># 由于未使用 Eureka，需要禁用掉默认的 Ribbon 负载均衡</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="comment"># 启用服务发现</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 集群地址</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="comment"># 集群端口</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># 启用服务注册</span></span><br><span class="line">        <span class="attr">register:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 服务注册名称</span></span><br><span class="line">        <span class="attr">serviceName:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="comment"># 服务注册 ID</span></span><br><span class="line">        <span class="attr">instanceId:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.consul.port&#125;</span></span><br><span class="line">        <span class="comment"># 服务健康检查地址</span></span><br><span class="line">        <span class="attr">healthCheckPath:</span> <span class="string">/actuator/health</span></span><br><span class="line">        <span class="comment"># 服务健康检查时间间隔</span></span><br><span class="line">        <span class="attr">healthCheckInterval:</span> <span class="string">10s</span></span><br><span class="line">        <span class="comment"># 连接不上 Consul，则抛出异常，终止应用程序启动</span></span><br><span class="line">        <span class="comment"># 本地开发时，可能需要设置为 false</span></span><br><span class="line">        <span class="attr">failFast:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在上例中，consul 相关配置都是使用的默认值，即不配置也可以运行。</li>
<li>由于 Spring Cloud 默认会采用 Ribbon 作为负载均衡实现，而这里没有使用 Eureka，所以需要禁用到 Ribbon 负载均衡。</li>
<li>如果使用了 Spring Cloud Config，属性 spring.application.name 需配置在 bootstrap.yml 中。</li>
<li>如果使用了 Spring Cloud Consul Config，consul 相关属性需配置在 bootstrap.yml 中。</li>
</ul>
<h3 id="查找服务"><a href="#查找服务" class="headerlink" title="查找服务"></a>查找服务</h3><h4 id="使用-Feign"><a href="#使用-Feign" class="headerlink" title="使用 Feign"></a>使用 Feign</h4><p><strong>定义 API 接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"account"</span>, path = <span class="string">"account"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"username"</span>)</span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>调用 API 接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"seckill"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountApi accountApi;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"orderId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Username: &#123;&#125;"</span>, accountApi.getUsername());</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-RestTemplate"><a href="#使用-RestTemplate" class="headerlink" title="使用 RestTemplate"></a>使用 RestTemplate</h4><p><strong>声明负载均衡 RestTemplate：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">loadbalancedRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用 RestTemplate：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"seckill"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"orderId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Username: &#123;&#125;"</span>, restTemplate.getForObject(<span class="string">"http://account/account/username"</span>, String<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-DiscoveryClient"><a href="#使用-DiscoveryClient" class="headerlink" title="使用 DiscoveryClient"></a>使用 DiscoveryClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">"STORES"</span>);</span><br><span class="line">    <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        URI uri = list.get(<span class="number">0</span>).getUri();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HTTP-健康检查"><a href="#HTTP-健康检查" class="headerlink" title="HTTP 健康检查"></a>HTTP 健康检查</h3><p>健康检查默认为 /actuator/health，时间间隔默认为 10s。我们可以通过以下属性进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># 服务健康检查地址</span></span><br><span class="line">        <span class="attr">healthCheckPath:</span> <span class="string">/actuator/health</span></span><br><span class="line">        <span class="comment"># 服务健康检查时间间隔</span></span><br><span class="line">        <span class="attr">healthCheckInterval:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure>

<p>可以通过设置 <code>management.health.consun.enabled=false</code> 来禁用运行状况检查。</p>
<h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><h3 id="Maven-依赖-1"><a href="#Maven-依赖-1" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 服务注册与发现 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置属性-1"><a href="#配置属性-1" class="headerlink" title="配置属性"></a>配置属性</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">account</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="comment"># 启用 consul</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 集群地址</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="comment"># 集群端口</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="comment"># 配置中心</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment"># 启用配置中心</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 根文件夹</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">config</span></span><br><span class="line">        <span class="comment"># 文件格式，默认值 KEY_VALUE</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">YAML</span></span><br><span class="line">        <span class="comment"># 文件名</span></span><br><span class="line">        <span class="attr">data-key:</span> <span class="string">data</span></span><br><span class="line">        <span class="comment"># 应用名和环境分隔符，默认值 ,</span></span><br><span class="line">        <span class="attr">profile-separator:</span> <span class="string">'-'</span></span><br><span class="line">        <span class="comment"># 连接不上 Consul，则抛出异常，终止应用程序启动</span></span><br><span class="line">        <span class="comment"># 本地开发时，可能需要设置为 false</span></span><br><span class="line">        <span class="attr">failFast:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置属性需放在 bootstrap.yml 文件中。</li>
<li>在上例中，除 format 和 profile-separator 属性外，其它 consul 相关配置都是使用的默认值，即不配置也可以运行。</li>
</ul>
<h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><ol>
<li>在 Consul 界面 Key/Value 菜单下创建目录：</li>
</ol>
<ul>
<li>config/account/data account 应用的默认配置</li>
<li>config/account-dev/data account 应用的 dev 环境配置</li>
</ul>
<p>我们也可以创建另外两个目录：</p>
<ul>
<li>config/application/data 所有应用的默认配置</li>
<li>config/application-dev/data 所有应用的 dev 环境配置</li>
</ul>
<ol start="2">
<li>在 data 路径下添加配置属性：<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">account</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">loadbalancer:</span></span><br><span class="line">      <span class="attr">ribbon:</span></span><br><span class="line">        <span class="comment"># 由于未使用 Eureka，需要禁用掉默认的 Ribbon 负载均衡</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="comment"># 启用 consul</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 集群地址</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="comment"># 集群端口</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="comment"># 服务发现</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># 启用服务发现</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 启用服务注册</span></span><br><span class="line">        <span class="attr">register:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 服务注册名称</span></span><br><span class="line">        <span class="attr">serviceName:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="comment"># 服务注册 ID</span></span><br><span class="line">        <span class="attr">instanceId:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.consul.port&#125;</span></span><br><span class="line">        <span class="comment"># 服务健康检查地址</span></span><br><span class="line">        <span class="attr">healthCheckPath:</span> <span class="string">/actuator/health</span></span><br><span class="line">        <span class="comment"># 服务健康检查时间间隔</span></span><br><span class="line">        <span class="attr">healthCheckInterval:</span> <span class="string">10s</span></span><br><span class="line">        <span class="comment"># 连接不上 Consul，则抛出异常，终止应用程序启动</span></span><br><span class="line">        <span class="comment"># 本地开发时，可能需要设置为 false</span></span><br><span class="line">        <span class="attr">failFast:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">watch:</span></span><br><span class="line">        <span class="comment"># 启动 watch</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># watch 调用频率，单位：毫秒</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="number">1000</span></span><br><span class="line">        <span class="comment"># watch 查询阻塞时间，单位：秒</span></span><br><span class="line">        <span class="comment"># 默认值 55 秒，这意味着连续两次快速的修改配置属性，属性不会立即更新为最新的值，因为前面的 watch 查询阻塞了后面的查询</span></span><br><span class="line">        <span class="attr">wait-time:</span> <span class="number">55</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="comment"># 默认只暴露了 health/info 端点</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">health,info,metrics,refresh,gateway</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>经过以上两步操作之后，在启动应用程序之后，便会从 Consul 中加载配置属性。</p>
<h3 id="动态刷新配置属性"><a href="#动态刷新配置属性" class="headerlink" title="动态刷新配置属性"></a>动态刷新配置属性</h3><p>如果 Consul 中配置属性发生了变化，我们可以通过向 /refresh 端点发送 HTTP POST 请求，来重新加载配置。 /refresh 端点会将发生变化（新增、修改或删除）的属性列表返回给我们。</p>
<p>但是， /refresh 端点并不能动态刷新应用程序中的属性，要做到这点，还需在用到属性的 bean 上添加 @RefreshScope 注解，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"account"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;username:admin&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"username"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实，即使我们不调用 /refresh 端点，配置属性也会自动刷新，这是因为 Consul Config Watch 利用 Consul 的能力来监控配置属性是否发生变化。我们可以通过设置 watch 相关属性，来启用或关闭 watch，及调整 watch 频率等，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">watch:</span></span><br><span class="line">        <span class="comment"># 启动 watch</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># watch 调用频率，单位：毫秒</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="number">1000</span></span><br><span class="line">        <span class="comment"># watch 查询阻塞时间，单位：秒</span></span><br><span class="line">        <span class="comment"># 默认值 55 秒，这意味着连续两次快速的修改配置属性，属性不会立即更新为最新的值，因为前面的 watch 查询阻塞了后面的查询</span></span><br><span class="line">        <span class="attr">wait-time:</span> <span class="number">55</span></span><br></pre></td></tr></table></figure>

<h2 id="Consul-重试"><a href="#Consul-重试" class="headerlink" title="Consul 重试"></a>Consul 重试</h2><p>在应用程序启动时，如果遇到 Consul Agent 连接不上，可以设置重试次数。只需引入以下 2 个依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，会重试 6 次，初始回退间隔为 1000 ms，后续回退的指数乘数为 1.1。我们可以使用 spring.cloud.consul.retry.* 配置属性来配置这些属性(以及其它属性)。</p>
<p>Consul 重试既可以在服务发现中使用，也可以在配置中心中使用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/29/Spring%20Cloud%20OpenFeign%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/29/Spring%20Cloud%20OpenFeign%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">Spring Cloud OpenFeign 开发实践</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-29 10:03:00" itemprop="dateCreated datePublished" datetime="2020-02-29T10:03:00+08:00">2020-02-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><ol>
<li>在 account-api 模块中定义 API 接口 AccountApi。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"account"</span>, url = <span class="string">"http://localhost:8082"</span>, path = <span class="string">"account"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"username"</span>)</span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>name 客户端名称，必要属性。如果项目使用了服务发现，name 属性需指定为微服务的名称。</li>
<li>url 服务地址，一般用于调试。</li>
<li>contextId 具有多个相同名称的 Feign 客户端时，需要设置该属性以区分。</li>
<li>path 请求的 mapping 前缀。</li>
<li>fallback 定义容错的处理类，当调用远程接口失败或超时时，会调用对应接口的容错逻辑，fallback 指定的类必须实现 @FeignClient 标记的接口。</li>
<li>fallbackFactory 工厂类，用于生成 fallback 类实例，通过这个属性我们可以实现每个接口通用的容错逻辑，减少重复的代码。</li>
<li>configuration Feign 配置类，可以自定义 Feign 的 Encoder、Decoder、Contract、LogLevel。</li>
<li>decode404 当发生 HTTP 404 错误时，如果该属性为 true，会调用 decoder 进行解码，否则抛出 FeignException。</li>
</ul>
<ol start="2">
<li>在 account-api 模块中定义 AccountController。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"account"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"username"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"admin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：AccountController 不应该继承 AccountApi，因为这会导致服务的调用方和提供方紧密耦合。同时在 SpringMVC 中会有问题，因为请求参数映射是不能被继承的。</strong> </p>
<ol start="3">
<li>在 seckill-web 中启动 Feign 客户端。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span>(basePackages = &#123;<span class="string">"account"</span>&#125;)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SeckillApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 默认会扫描启动类所在根路径下的所有使用了注解 @FeignClient 的 Feign 客户端，如果 Feign 客户端不在启动类所在根路径下，则需要设置 @EnableFeignClients 的属性 basePackages 来指定要扫描的包。</p>
<ol start="5">
<li>在 seckill-web 中使用 API 接口。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"seckill"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountApi accountApi;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"orderId"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Username: &#123;&#125;"</span>, accountApi.getUsername());</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="服务发现支持"><a href="#服务发现支持" class="headerlink" title="服务发现支持"></a>服务发现支持</h2><p>如果我们使用了服务发现，如 Consul 或 Eureka，那么在注解 @FeignClient 中就不需要再指定 url 属性，需要注意的是注解 @FeignClient 的 name 属性要与服务注册中心的服务名一致。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/Spring%20Cloud%20OpenFeign%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/28/Spring%20Cloud%20OpenFeign%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">Spring Cloud OpenFeign 开发指南</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-28 18:42:00" itemprop="dateCreated datePublished" datetime="2020-02-28T18:42:00+08:00">2020-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Feign 是一个声明式 web 服务客户端，使用它能让编写 web 服务客户端更加简单。Feign 的使用方法是定义一个接口，然后在上面添加注解。它支持可插入的注解支持，包括 Feign 注解和 JAX-RS 注解，同时也支持可插拔的编码器和解码器。Spring Cloud 增加了对 Spring MVC 注解的支持，并支持使用 Spring Web 中默认使用的 HttpMessageConverters。Spring Cloud 集成了 Ribbon 和 Eureka，以及 Spring Cloud LoadBalancer，从而可以使用 Feign 来实现 HTTP 客户端负载均衡。</p>
<h2 id="引入-Feign"><a href="#引入-Feign" class="headerlink" title="引入 Feign"></a>引入 Feign</h2><p>要在项目中引入 Feign，需要添加以下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>使用示例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"stores"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StoreClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/stores"</span>)</span><br><span class="line">    <span class="function">List&lt;Store&gt; <span class="title">getStores</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.POST, value = <span class="string">"/stores/&#123;storeId&#125;"</span>, consumes = <span class="string">"application/json"</span>)</span><br><span class="line">    <span class="function">Store <span class="title">update</span><span class="params">(@PathVariable(<span class="string">"storeId"</span>)</span> Long storeId, Store store)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 @FeignClient 注解中，字符串值(上面的 “stores”)是一个任意的客户端名称，用于创建 Ribbon 负载均衡器。还可以使用 url 属性(绝对值或主机名)指定 URL。应用程序上下文中 bean 的名称是接口的完全限定名。要指定自己的别名值，可以使用 @FeignClient 注解的 qualifier 的值。</p>
<p>上面的负载均衡客户端期待发现 “stores” 服务的物理地址。如果我们的应用程序是一个 Eureka 客户端，那么它将在 Eureka 服务注册表中解析服务。如果我们的不想使用Eureka，可以简单地在外部配置中配置一个服务器列表（eg. stores.ribbon.listOfServers: example.com,google.com）。</p>
<p><strong>注意：</strong> 为了保持向后兼容性，Spring Cloud Netflix Ribbon 被用作默认的负载均衡实现。但是，Spring Cloud Netflix Ribbon 现在处于维护模式，所以建议大家使用 Spring Cloud LoadBalancer 来代替。为此，设置 spring.cloud.loadbalancer.ribbon.enabled=false。</p>
<h2 id="覆盖-Feign-默认配置"><a href="#覆盖-Feign-默认配置" class="headerlink" title="覆盖 Feign 默认配置"></a>覆盖 Feign 默认配置</h2><p>Spring Cloud Feign 中一个核心的概念就是客户端要有一个名字。每一个客户端随时可以向远程服务发起请求，并且每个服务都可以像使用 @FeignClient 注解一样指定一个名字。Spring Cloud 会将所有的 @FeignClient 组合在一起创建一个新的 ApplicationContext, 并使 用FeignClientsConfiguration对Clients 进行配置。配置中包括一个 feign.Decoder，一个 feign.Encoder 和一个 feign.Contract。</p>
<p>Spring Cloud 允许我们通过 configuration 属性完全控制 Feign 的配置信息，这些配置比 FeignClientsConfiguration 优先级要高：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"stores"</span>, configuration = FooConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">StoreClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，FooConfiguration 中的配置信息会覆盖掉 FeignClientsConfiguration 中对应的配置。</p>
<p><strong>注意：</strong> FooConfiguration 虽然是个配置类，但是它不应该被主上下文（ApplicationContext）扫描到，否则该类中的配置信息就会被应用于所有的 @FeignClient 客户端(本例中 FooConfiguration 中的配置应该只对 StoreClient 起作用)。</p>
<p><strong>注意：</strong> serviceId 属性已经被弃用了，取而代之的是 name 属性。</p>
<p><strong>注意：</strong> 在先前的版本中在指定了 url 属性时 name 是可选属性，现在无论什么时候 name 都是必填属性。</p>
<p>name 和 url 属性也支持占位符：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"$&#123;feign.name&#125;"</span>, url = <span class="string">"$&#123;feign.url&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StoreClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring Cloud Netflix 为 Feign 默认提供了以下的 beans：（BeanType beanName: ClassName）</p>
<ul>
<li>Decoder feignDecoder: ResponseEntityDecoder (which wraps a SpringDecoder)</li>
<li>Encoder feignEncoder: SpringEncoder</li>
<li>Logger feignLogger: Slf4jLogger</li>
<li>Contract feignContract: SpringMvcContract</li>
<li>Feign.Builder feignBuilder: HystrixFeign.Builder</li>
<li>Client feignClient: 如果 Ribbon 在类路径中，并且启用了它，那么它就是 LoadBalancerFeignClient，否则，如果 Spring Cloud LoadBalancer 在类路径中，那么就使用 FeignBlockingLoadBalancerClient 。如果它们都不在类路径中，则使用默认的 Feign 客户端。</li>
</ul>
<p><strong>注意：</strong> spring-cloud-starter-openfeign 既包含 spring-cloud-starter-netflix-ribbon，也包含spring-cloud-starter-loadbalancer。</p>
<p>如果要使用 ApacheHttpClient，我们可以将 feign.httpclient.enabled 设置为 true，并保证类路径上有对应的库。还可以通过定义一个 org.apache.http.impl.client.CloseableHttpClient bean 来定制 HTTP 客户端。<br>如果要使用 OkHttpClient，我们可以将 feign.okhttp.enabled 设置为 true，并保证类路径上有对应的库。还可以通过定义一个 okhttp3.OkHttpClient bean 来定制 HTTP 客户端。</p>
<p>Spring Cloud Netflix 默认没有为 Feign 提供以下的 beans，但是在应用启动时依然会从上下文中查找这些 beans 来构造客户端对象：</p>
<ul>
<li>Logger.Level</li>
<li>Retryer</li>
<li>ErrorDecoder</li>
<li>Request.Options</li>
<li><code>Collection&lt;RequestInterceptor&gt;</code></li>
</ul>
<p>如果想要覆盖 Spring Cloud Netflix 默认提供的 beans，需要在 @FeignClient 的 configuration 属性中指定一个配置类，并提供想要覆盖的 beans 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Contract <span class="title">feignContract</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> feign.Contract.Default();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BasicAuthRequestInterceptor <span class="title">basicAuthRequestInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BasicAuthRequestInterceptor(<span class="string">"user"</span>, <span class="string">"password"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在本例中，我们用 feign.Contract.Default 代替了 SpringMvcContract, 并添加了一个 RequestInterceptor。以这种方式做的配置会在所有的 @FeignClient 中生效。</p>
<p>还可以使用配置属性配置 @FeignClient。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">feignName:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">full</span></span><br><span class="line">        <span class="attr">errorDecoder:</span> <span class="string">com.example.SimpleErrorDecoder</span></span><br><span class="line">        <span class="attr">retryer:</span> <span class="string">com.example.SimpleRetryer</span></span><br><span class="line">        <span class="attr">requestInterceptors:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">com.example.FooRequestInterceptor</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">com.example.BarRequestInterceptor</span></span><br><span class="line">        <span class="attr">decode404:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">encoder:</span> <span class="string">com.example.SimpleEncoder</span></span><br><span class="line">        <span class="attr">decoder:</span> <span class="string">com.example.SimpleDecoder</span></span><br><span class="line">        <span class="attr">contract:</span> <span class="string">com.example.SimpleContract</span></span><br></pre></td></tr></table></figure>

<p>可以在 @EnableFeignClients 的属性 defaultConfiguration 中以类似的方式指定默认配置，如上所述。不同的是，这种配置将适用于所有的 Feign 客户端。</p>
<p>如果我们想要使用配置属性来配置所有 @FeignClient，可以使用 default Feign 名称来创建配置属性。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">basic</span></span><br></pre></td></tr></table></figure>

<p>如果我们同时创建 @Configuration bean和配置属性，则配置属性优先级更高，它将覆盖 @Configuration 值。但是，如果我们想将更改为 @Configuration 优先级更高，则可以将 feign.client.default-to-properties 更改为 false。</p>
<p><strong>注意：</strong> 如果我们需要在 RequestInterceptor 中使用 ThreadLocal 变量，那么我们需要将 Hystrix 的线程隔离策略设置为 SEMAPHORE，或者在 Feign 中禁用 Hystrix。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To disable Hystrix in Feign</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To set thread isolation to SEMAPHORE</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">SEMAPHORE</span></span><br></pre></td></tr></table></figure>

<p>如果我们想创建多个具有相同名称或 url 的 Feign 客户端，以便它们指向相同的服务器，但每个服务器都具有不同的自定义配置，那么我们必须使用 @FeignClient 的 contextId 属性，以避免这些配置 bean 的名称冲突。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(contextId = <span class="string">"fooClient"</span>, name = <span class="string">"stores"</span>, configuration = FooConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">FooClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@FeignClient</span>(contextId = <span class="string">"barClient"</span>, name = <span class="string">"stores"</span>, configuration = BarConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">BarClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Feign-对-Hystrix-的支持"><a href="#Feign-对-Hystrix-的支持" class="headerlink" title="Feign 对 Hystrix 的支持"></a>Feign 对 Hystrix 的支持</h2><p>如果 Hystrix 在类路径中且设置了 feign.hystrix.enabled=true，Feign 会默认将所有方法都封装到断路器中。还可以返回 com.netflix.hystrix.HystrixCommand。这允许我们使用响应模式（通过调用 .toObservable() 或 .observe() 或 异步使用（通过调用.queue()））。</p>
<p>如果想只关闭指定客户端的 Hystrix 支持，创建一个 Feign.Builder 组件并标注为 @Scope(prototype)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">    <span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Feign.builder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Feign-对-Hystrix-Fallback-的支持"><a href="#Feign-对-Hystrix-Fallback-的支持" class="headerlink" title="Feign 对 Hystrix Fallback 的支持"></a>Feign 对 Hystrix Fallback 的支持</h2><p>Hystrix 支持 fallback 的概念，即当断路器打开或发生错误时执行指定的失败逻辑。要为指定的 @FeignClient 启用 Fallback 支持， 需要在 fallback 性中指定实现类。还需要将实现类声明为 Spring bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"hello"</span>, fallback = HystrixClientFallback<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">protected</span> <span class="title">interface</span> <span class="title">HystrixClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function">Hello <span class="title">iFailSometimes</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixClientFallback</span> <span class="keyword">implements</span> <span class="title">HystrixClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hello <span class="title">iFailSometimes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(<span class="string">"fallback"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要访问 fallback 触发的原因，可以在 @FeignClient 中使用 fallbackFactory 属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"hello"</span>, fallbackFactory = HystrixClientFallbackFactory<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">protected</span> <span class="title">interface</span> <span class="title">HystrixClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function">Hello <span class="title">iFailSometimes</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title">FallbackFactory</span>&lt;<span class="title">HystrixClient</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HystrixClient <span class="title">create</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HystrixClient() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Hello <span class="title">iFailSometimes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Hello(<span class="string">"fallback; reason was: "</span> + cause.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> Feign 对 Hystrix Fallback 的支持有一个限制：对于返回 com.netflix.hystrix.HystrixCommand 或 rx.Observable 对象的方法，fallback 不起作用。</p>
<h2 id="Feign-和-Primary"><a href="#Feign-和-Primary" class="headerlink" title="Feign 和 @Primary"></a>Feign 和 @Primary</h2><p>当使用 Feign 和 Hystrix fallbacks 时，ApplicationContext 会存在多个相同类型的 bean。这将导致 @Autowired 不能工作，因为没有一个精确的 bean，或者一个标记为主 bean。为了解决这个问题，Spring Cloud Netflix 将所有 Feign 实例标记为 @Primary，因此 Spring Framework 将知道注入哪个 bean。在某些情况下，这可能是不可取的。要关闭此行为，需将 @FeignClient 的 primary 属性设置为 false。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"hello"</span>, primary = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">// methods here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Feign-对继承的支持"><a href="#Feign-对继承的支持" class="headerlink" title="Feign 对继承的支持"></a>Feign 对继承的支持</h2><p>Feign 可以通过 Java 的接口支持继承。我们可以把一些公共的操作放到父接口中，然后定义子接口继承之：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value =<span class="string">"/users/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">User <span class="title">getUser</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> <span class="keyword">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserResource</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> project.user;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserClient</span> <span class="keyword">extends</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：在服务的调用端和提供端共用同一个接口定义是不明智的，这会将调用端和提供端的代码紧紧耦合在一起。同时在 SpringMVC 中会有问题，因为请求参数映射是不能被继承的。</strong> </p>
<h2 id="Feign-对压缩的支持"><a href="#Feign-对压缩的支持" class="headerlink" title="Feign 对压缩的支持"></a>Feign 对压缩的支持</h2><p>我们可能会想要对请求/响应数据进行 Gzip 压缩，指定以下参数即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">feign.compression.request.enabled=true</span></span><br><span class="line"><span class="string">feign.compression.response.enabled=true</span></span><br></pre></td></tr></table></figure>

<p>也可以添加一些更细粒度的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">feign.compression.request.enabled=true</span></span><br><span class="line"><span class="string">feign.compression.request.mime-types=text/xml,application/xml,application/json</span></span><br><span class="line"><span class="string">feign.compression.request.min-request-size=2048</span></span><br></pre></td></tr></table></figure>

<p>上面的 3 个参数可以让我们选择对哪种请求进行压缩，并设置一个最小请求大小的阀值。</p>
<p>对于除 OkHttpClient 外的 HTTP 客户端，可以启用默认的 gzip 解码器对 gzip 响应进行 UTF-8编码解码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">feign.compression.response.enabled=true</span></span><br><span class="line"><span class="string">feign.compression.response.useGzipDecoder=true</span></span><br></pre></td></tr></table></figure>

<h2 id="Feign-日志"><a href="#Feign-日志" class="headerlink" title="Feign 日志"></a>Feign 日志</h2><p>每一个 @FeignClient 都会创建一个 Logger, Logger 的名字就是接口的全限定名。Feign 的日志配置参数仅支持 DEBUG：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.level.project.user.UserClient:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<p>Logger.Level 对象允许我们为指定客户端配置想记录哪些信息：</p>
<ul>
<li>NONE 不记录任何信息，默认值。</li>
<li>BASIC 记录请求方法、请求URL、状态码和用时。</li>
<li>HEADERS 在BASIC的基础上再记录一些常用信息。</li>
<li>FULL 记录请求和响应报文的全部内容。</li>
</ul>
<p>下面的示例将 Level 设置为 FULL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Feign-对-QueryMap-的支持"><a href="#Feign-对-QueryMap-的支持" class="headerlink" title="Feign 对 @QueryMap 的支持"></a>Feign 对 @QueryMap 的支持</h2><p>OpenFeign @QueryMap 注解支持将 POJOs 作为 GET 参数映射。不幸的是，默认的 OpenFeign QueryMap 注解与 Spring 不兼容，因为它缺少值属性。</p>
<p>Spring Cloud OpenFeign 提供了一个等价的 @SpringQueryMap 注解，用于将 POJO 或 Map 参数注释为查询参数映射。</p>
<p>例如，Params 类定义了参数 param1 和 param2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Params.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Params</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String param1;</span><br><span class="line">    <span class="keyword">private</span> String param2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [Getters and setters omitted for brevity]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的 Feign 客户端通过使用 @SpringQueryMap 注释来使用 Params类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"demo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoTemplate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"/demo"</span>)</span><br><span class="line">    <span class="function">String <span class="title">demoEndpoint</span><span class="params">(@SpringQueryMap Params params)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要对生成的查询参数映射进行更多的控制，可以实现一个定制的 QueryMapEncoder bean。</p>
<h2 id="HATEOAS-支持"><a href="#HATEOAS-支持" class="headerlink" title="HATEOAS 支持"></a>HATEOAS 支持</h2><p>Spring 提供了一些 API 来创建遵循 HATEOAS 原则、Spring HATEOAS 和 Spring Data REST 的 REST 表示。</p>
<p>如果项目使用 org.springframework.boot:spring-boot-starter-hateoas starter 或 org.springframework.boot:spring-boot-starter-data-rest starter，默认启用 Feign HATEOAS 支持。</p>
<p>当 HATEOAS 支持被启用时，Feign 客户端可以序列化和反序列化 HATEOAS 表示模型：EntityModel、CollectionModel 和 PagedModel。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"demo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoTemplate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"/stores"</span>)</span><br><span class="line">    <span class="function">CollectionModel&lt;Store&gt; <span class="title">getStores</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-openfeign/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">Spring Cloud OpenFeign</a></li>
<li><a href="https://www.bookstack.cn/read/spring-cloud-docs/docs-user-guide-feign.md" target="_blank" rel="noopener">声明式REST客户端Feign</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/Spring%20Cloud%20Circuit%20Breaker%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/28/Spring%20Cloud%20Circuit%20Breaker%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">Spring Cloud Circuit Breaker 开发指南</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-28 12:59:00" itemprop="dateCreated datePublished" datetime="2020-02-28T12:59:00+08:00">2020-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Resilience4j 是一款轻量级，易于使用的容错库，其灵感来自于 Netflix Hystrix，专为 Java8 和函数式编程而设计。轻量级，因为库只使用了 Vavr，它没有任何其他外部依赖下。相比之下，Netflix Hystrix 对 Archaius 具有编译依赖性，Archaius 具有更多的外部库依赖性，例如 Guava 和 Apache Commons Configuration。</p>
<h2 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 断路器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-circuitbreaker-reactor-resilience4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h2><p>可以通过设置 spring.cloud.circuitbreaker.resilience4j.enabled=false 来禁用 Resilience4J 自动装配。</p>
<h2 id="断路器配置"><a href="#断路器配置" class="headerlink" title="断路器配置"></a>断路器配置</h2><h3 id="配置属性"><a href="#配置属性" class="headerlink" title="配置属性"></a>配置属性</h3><table>
<thead>
<tr>
<th align="center">配置属性</th>
<th align="center">默认值</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">failureRateThreshold</td>
<td align="center">50（%）</td>
<td align="center">当故障率等于或大于阈值时，CircuitBreaker 转换为打开状态并开始短路调用。</td>
</tr>
<tr>
<td align="center">slowCallRateThreshold</td>
<td align="center">100</td>
<td align="center">配置百分比阈值。当慢速调用的百分比等于或大于阈值时，CircuitBreaker 转换为打开并开始短路调用。</td>
</tr>
<tr>
<td align="center">slowCallDurationThreshold</td>
<td align="center">60（s）</td>
<td align="center">配置持续时间阈值，在该阈值以上，调用将被视为慢速并增加慢速调用的速率。</td>
</tr>
<tr>
<td align="center">permittedNumberOfCallsInHalfOpenState</td>
<td align="center">10</td>
<td align="center">配置当 CircuitBreaker 半开时允许的调用数。</td>
</tr>
<tr>
<td align="center">slideWindowType</td>
<td align="center">COUNT_BASED</td>
<td align="center">配置滑动窗口的类型，该窗口用于在 CircuitBreaker 关闭时记录调用结果。滑动窗口可以基于计数或基于时间。如果滑动窗口为 COUNT_BASED，slidingWindowSize 则记录并汇总最近的调用。 如果滑动窗口是 TIME_BASED，则 slidingWindowSize 记录并汇总最近几秒的调用。</td>
</tr>
<tr>
<td align="center">slideWindowSize</td>
<td align="center">100</td>
<td align="center">配置滑动窗口的大小，该窗口用于记录 CircuitBreaker 关闭时的调用结果。</td>
</tr>
<tr>
<td align="center">minimumNumberOfCalls</td>
<td align="center">10</td>
<td align="center">配置 CircuitBreaker 可以计算错误率之前所需的最小调用数（每个滑动窗口时段）。例如，如果 minimumNumberOfCalls 为 10，则在计算失败率之前，必须至少记录 10 个调用。如果仅记录了 9 个调用，则即使所有 9 个调用均失败，CircuitBreaker 也不会转换为打开。</td>
</tr>
<tr>
<td align="center">waitDurationInOpenState</td>
<td align="center">60（s）</td>
<td align="center">从打开状态转为半开状态等待的时间。</td>
</tr>
<tr>
<td align="center">recordExceptions</td>
<td align="center">empty</td>
<td align="center">需要记录的异常列表。</td>
</tr>
<tr>
<td align="center">ignoreExceptions</td>
<td align="center">empty</td>
<td align="center">需要忽略的异常列表。</td>
</tr>
<tr>
<td align="center">recordException</td>
<td align="center">throwable -&gt; true 默认情况下，所有异常都记录为失败。</td>
<td align="center">用于评估是否应将异常记录为失败。如果异常应计为失败，则必须返回 true。如果异常应被视为成功，则必须返回 false，除非该异常被显式忽略 ignoreExceptions。</td>
</tr>
<tr>
<td align="center">ignoreException</td>
<td align="center">throwable -&gt;false 默认情况下，不会忽略任何异常。</td>
<td align="center">用于评估是否应忽略异常，并且该异常既不算作失败也不算成功。如果应忽略异常，则必须返回 true。否则必须返回 false。</td>
</tr>
<tr>
<td align="center">automaticTransitionFromOpenToHalfOpenEnabled</td>
<td align="center">false</td>
<td align="center">如果置为true，当等待时间结束会自动由打开变为半开，若置为 false，则需要一个请求进入来触发熔断器状态转换。</td>
</tr>
</tbody></table>
<h3 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h3><p>要为所有断路器提供默认配置，需要创建一个自定义 bean，该 bean 通过一个 ReactiveResilience4JCircuitBreakerFactory 传递。可以使用 configureDefault 方法提供默认配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Customizer&lt;ReactiveResilience4JCircuitBreakerFactory&gt; <span class="title">defaultCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> factory -&gt; factory.configureDefault(id -&gt; <span class="keyword">new</span> Resilience4JConfigBuilder(id)</span><br><span class="line">            .circuitBreakerConfig(CircuitBreakerConfig.ofDefaults())</span><br><span class="line">            <span class="comment">// 限制远程调用所花费的时间</span></span><br><span class="line">            .timeLimiterConfig(TimeLimiterConfig.custom().timeoutDuration(Duration.ofSeconds(<span class="number">5</span>)).build()).build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="特殊配置"><a href="#特殊配置" class="headerlink" title="特殊配置"></a>特殊配置</h3><p>与提供默认配置类似，我们可以创建一个自定义 bean，它传递给一个 ReactiveResilience4JCircuitBreakerFactory。</p>
<p>除了配置所创建的断路器之外，我们还可以在断路器创建之后，但在它返回给调用者之前，对其进行自定义。为此，可以使用 addCircuitBreakerCustomizer  方法。这对于向 Resilience4J 断路器添加事件处理程序是很有用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Customizer&lt;ReactiveResilience4JCircuitBreakerFactory&gt; <span class="title">slowCusomtizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> factory -&gt; &#123;</span><br><span class="line">        factory.configure(builder -&gt; builder</span><br><span class="line">        .timeLimiterConfig(TimeLimiterConfig.custom().timeoutDuration(Duration.ofSeconds(<span class="number">5</span>)).build())</span><br><span class="line">        .circuitBreakerConfig(CircuitBreakerConfig.ofDefaults()), <span class="string">"slow"</span>, <span class="string">"slowflux"</span>);</span><br><span class="line"></span><br><span class="line">        factory.addCircuitBreakerCustomizer(circuitBreaker -&gt; circuitBreaker.getEventPublisher()</span><br><span class="line">            .onError(normalFluxErrorConsumer).onSuccess(normalFluxSuccessConsumer), <span class="string">"normalflux"</span>);</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="收集指标"><a href="#收集指标" class="headerlink" title="收集指标"></a>收集指标</h3><p>Spring Cloud Circuit Breaker Resilience4j 包含自动配置来设置指标集合，只要类路径上有正确的依赖项。要启用度量集合，需要引入依赖 org.springframework.boot:spring-boot-starter-actuator 和 io.github.resilience4j:resilience4j-micrometer。有关这些依赖项出现时生成的度量标准的更多信息，<a href="https://resilience4j.readme.io/docs/micrometer" target="_blank" rel="noopener">参阅Resilience4j文档</a>。</p>
<h2 id="Spring-Retry-断路器配置"><a href="#Spring-Retry-断路器配置" class="headerlink" title="Spring Retry 断路器配置"></a>Spring Retry 断路器配置</h2><p>Spring Retry 为 Spring 应用程序提供声明性重试支持。项目的一部分包括实现断路器功能的能力。Spring Retry 通过它的 CircuitBreakerRetryPolicy 和有状态重试的组合提供了断路器实现。所有使用 Spring Retry 创建的断路器都将使用 CircuitBreakerRetryPolicy 和 DefaultRetryState 创建。这两个类都可以使用 SpringRetryConfigBuilder 来配置。</p>
<h3 id="默认配置-1"><a href="#默认配置-1" class="headerlink" title="默认配置"></a>默认配置</h3><p>要为所有断路器提供默认配置，需要创建一个通过 SpringRetryCircuitBreakerFactory 传递的定制 bean。可以使用 configureDefault 方法提供默认配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Customizer&lt;SpringRetryCircuitBreakerFactory&gt; <span class="title">defaultCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> factory -&gt; factory.configureDefault(id -&gt; <span class="keyword">new</span> SpringRetryConfigBuilder(id)</span><br><span class="line">        .retryPolicy(<span class="keyword">new</span> TimeoutRetryPolicy()).build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="特殊配置-1"><a href="#特殊配置-1" class="headerlink" title="特殊配置"></a>特殊配置</h3><p>与提供默认配置类似，我们可以创建一个自定义 bean，它通过 SpringRetryCircuitBreakerFactory 传递。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Customizer&lt;SpringRetryCircuitBreakerFactory&gt; <span class="title">slowCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> factory -&gt; factory.configure(builder -&gt; builder.retryPolicy(<span class="keyword">new</span> SimpleRetryPolicy(<span class="number">1</span>)).build(), <span class="string">"slow"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了配置所创建的断路器之外，我们还可以在断路器创建之后，但在它返回给调用者之前，对其进行自定义。为此，可以使用 addRetryTemplateCustomizers 方法。这对于将事件处理程序添加到 RetryTemplate 非常有用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Customizer&lt;SpringRetryCircuitBreakerFactory&gt; <span class="title">slowCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> factory -&gt; factory.addRetryTemplateCustomizers(retryTemplate -&gt; retryTemplate.registerListener(<span class="keyword">new</span> RetryListener() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T, E extends Throwable&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">open</span><span class="params">(RetryContext context, RetryCallback&lt;T, E&gt; callback)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T, E extends Throwable&gt; <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(RetryContext context, RetryCallback&lt;T, E&gt; callback, Throwable throwable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T, E extends Throwable&gt; <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(RetryContext context, RetryCallback&lt;T, E&gt; callback, Throwable throwable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-circuitbreaker/1.0.0.RELEASE/reference/html/" target="_blank" rel="noopener">Spring Cloud Circuit Breaker</a></li>
<li><a href="https://www.liangzl.com/get-article-detail-154284.html" target="_blank" rel="noopener">Spring Cloud Circuit Breaker</a></li>
<li><a href="https://blog.csdn.net/qwe86314/article/details/98873884" target="_blank" rel="noopener">SpringCloud之Resilience4J用法精讲</a></li>
<li><a href="https://blog.csdn.net/qwe86314/article/details/98984374" target="_blank" rel="noopener">SpringCloud之在微服务中使用Resilience4J</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E6%96%AD%E8%B7%AF%E5%99%A8(%E7%86%94%E6%96%AD&%E9%99%8D%E7%BA%A7&%E9%99%90%E6%B5%81&%E8%B6%85%E6%97%B6%E7%9B%91%E6%8E%A7)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/28/%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E6%96%AD%E8%B7%AF%E5%99%A8(%E7%86%94%E6%96%AD&%E9%99%8D%E7%BA%A7&%E9%99%90%E6%B5%81&%E8%B6%85%E6%97%B6%E7%9B%91%E6%8E%A7)/" class="post-title-link" itemprop="url">微服务-断路器（熔断、降级、限流、超时监控）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-28 10:34:00" itemprop="dateCreated datePublished" datetime="2020-02-28T10:34:00+08:00">2020-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index">
                    <span itemprop="name">微服务</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>众所周知，微服务架构具有许多优点。包含松散耦合，自治服务，分散治理，更容易连续交付等。但与此同时，它使架构变得脆弱，因为每个用户的操作结果都会调用多个服务。它通过网络上的远程调用替换了单体系结构中的内存调用。但是当一个或多个服务不可用或表现出高延迟时，会导致整个系统出现级联故障。服务客户端的重试逻辑只会使情况更糟糕，并且可能导致系统彻底的崩溃。</p>
<p><strong>断路器模式有助于防止跨多个系统的这种灾难性级联故障。断路器模式允许我们构建容错和弹性的系统，当关键服务不可用或具有高延迟时，系统仍然可以正常运行。</strong></p>
<h2 id="容错模式"><a href="#容错模式" class="headerlink" title="容错模式"></a>容错模式</h2><p><img src="/images/microservice/%E5%AE%B9%E9%94%99%E6%A8%A1%E5%BC%8F.png" alt="容错模式"></p>
<h3 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h3><p>当调用目标服务的请求和调用大量超时或失败，服务调用方为避免造成长时间的阻塞造成影响其他服务，后续对该服务接口的调用不再经过进行请求，直接执行本地的默认方法。</p>
<h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><p>为了保证核心业务在大量请求下能正常运行，根据实际业务情况及流量，对部分服务降低优先级，有策略的不处理或用简单的方式处理。</p>
<h3 id="服务限流"><a href="#服务限流" class="headerlink" title="服务限流"></a>服务限流</h3><p>当系统资源不够，不足以应对大量请求，对系统按照预设的规则进行流量限制或功能限制。</p>
<h3 id="回退"><a href="#回退" class="headerlink" title="回退"></a>回退</h3><p>在熔断或者限流发生的时候，应用程序的后续处理逻辑是什么？回退是系统的弹性恢复能力，常见的处理策略有，直接抛出异常，也称快速失败（Fail Fast），也可以返回空值或缺省值，还可以返回备份数据，如果主服务熔断了，可以从备份服务获取数据。</p>
<h2 id="容错理念"><a href="#容错理念" class="headerlink" title="容错理念"></a>容错理念</h2><ul>
<li>凡是依赖都可能会失败</li>
<li>凡是资源（CPU/Memory/Threads/Queue）都有限制</li>
<li>网络并不可靠</li>
<li>延迟是应用稳定性杀手</li>
</ul>
<h2 id="断路器模式"><a href="#断路器模式" class="headerlink" title="断路器模式"></a>断路器模式</h2><p>断路器模式源于 Martin Fowler 的 Circuit Breaker 一文。“断路器”本身是一种开关装置，用于在电路上保护线路过载，当线路中有电器发生短路时，“断路器”能够及时的切断故障电路，防止发生过载、发热、甚至起火等严重后果。</p>
<p>在分布式架构中，断路器模式的作用也是类似的，当某个服务单元发生故障（类似用电器发生短路）之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个错误响应，而不是长时间的等待。这样就不会使得线程因调用故障服务被长时间占用不释放，避免了故障在分布式系统中的蔓延。</p>
<h3 id="状态机模式"><a href="#状态机模式" class="headerlink" title="状态机模式"></a>状态机模式</h3><p>断路器的实现采用状态机模式，它有 3 种不同的状态：关闭、打开和半打开。</p>
<ul>
<li>关闭：当一切正常时，断路器保持闭合状态，所有调用都能访问到服务。当故障数超过预定阈值时，断路器跳闸，并进入打开状态。</li>
<li>打开：断路器在不执行该服务的情况下为调用返回错误。</li>
<li>半开：超时后，断路器切换到半开状态，以测试问题是否仍然存在。如果在这种半开状态下单个调用失败，则断路器再次打开。如果成功，则断路器重置回正常关闭状态。</li>
</ul>
<p><img src="/images/microservice/%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%BC%8F.png" alt="状态机模式"></p>
<p><img src="/images/microservice/%E6%96%AD%E8%B7%AF%E5%99%A8%E6%A8%A1%E5%BC%8F.png" alt="断路器模式"></p>
<h3 id="舱壁隔离模式"><a href="#舱壁隔离模式" class="headerlink" title="舱壁隔离模式"></a>舱壁隔离模式</h3><p>舱壁隔离模式，顾名思义，该模式像舱壁一样对资源或失败单元进行隔离，如果一个船舱破了进水，只损失一个船舱，其它船舱可以不受影响 。线程隔离就是舱壁隔离模式的一个例子，假定一个应用程序 A 调用了 Svc1/Svc2/Svc3 三个服务，且部署 A 的容器一共有 120 个工作线程，采用线程隔离机制，可以给对 Svc1/Svc2/Svc3 的调用各分配 40 个线程，当 Svc2 慢了，给 Svc2 分配的 40 个线程因慢而阻塞并最终耗尽，线程隔离可以保证给 Svc1/Svc3 分配的 80 个线程可以不受影响，如果没有这种隔离机制，当 Svc2 慢的时候，120 个工作线程会很快全部被对 Svc2 的调用吃光，整个应用程序会全部慢下来。</p>
<h2 id="线程池隔离与信号量隔离"><a href="#线程池隔离与信号量隔离" class="headerlink" title="线程池隔离与信号量隔离"></a>线程池隔离与信号量隔离</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><img src="/images/microservice/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8E%E4%BF%A1%E5%8F%B7%E9%87%8F%E9%9A%94%E7%A6%BB.png" alt="线程池与信号量隔离"></p>
<ul>
<li>线程池隔离：每次都开启一个单独线程运行。它的隔离是通过线程池，即每个隔离粒度都是个线程池，互相不干扰。</li>
<li>信号量隔离：每次调用线程，当前请求通过计数信号量进行限制，当信号大于了最大请求数（maxConcurrentRequests）时，进行限制。</li>
</ul>
<h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><p><strong>特性对比：</strong></p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">线程池隔离</th>
<th align="center">信号量隔离</th>
</tr>
</thead>
<tbody><tr>
<td align="center">隔离原理</td>
<td align="center">每个服务单独用线程池</td>
<td align="center">通过信号量的计数器</td>
</tr>
<tr>
<td align="center">是否支持熔断</td>
<td align="center">支持，当线程池到达MaxSize后，再请求会触发fallback接口进行熔断</td>
<td align="center">支持，当信号量达到maxConcurrentRequest后，再请求会触发fallback</td>
</tr>
<tr>
<td align="center">是否支持超时</td>
<td align="center">支持，可直接返回</td>
<td align="center">不支持，如果阻塞，只能通过调用协议</td>
</tr>
<tr>
<td align="center">是否支持异步调用</td>
<td align="center">可以是异步，也可以是同步。看调用的方法</td>
<td align="center">同步调用，不支持异步</td>
</tr>
<tr>
<td align="center">资源消耗</td>
<td align="center">大，大量线程的上下文切换，容易造成机器负载高</td>
<td align="center">小，只是个计数器</td>
</tr>
</tbody></table>
<p><strong>优缺点对比：</strong></p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">优点</th>
<th align="center">不足</th>
<th align="center">适用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">线程池隔离</td>
<td align="center">支持任务排队和超时<br>支持异步调用</td>
<td align="center">线程调用会产生额外的开销</td>
<td align="center">不受信客户<br>有限扇出</td>
</tr>
<tr>
<td align="center">信号量隔离</td>
<td align="center">轻量，无额外开销</td>
<td align="center">不支持任务排队和主动超时<br>不支持异步调用</td>
<td align="center">受信客户<br>高扇出（网关）<br>高频高速调用（cache）</td>
</tr>
</tbody></table>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p><strong>线程池隔离案例：</strong><br><img src="/images/microservice/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB%E6%A1%88%E4%BE%8B.png" alt="线程池隔离案例"></p>
<h2 id="主流开源断路器概览"><a href="#主流开源断路器概览" class="headerlink" title="主流开源断路器概览"></a>主流开源断路器概览</h2><table>
<thead>
<tr>
<th align="center"></th>
<th align="center">Sentinel</th>
<th align="center">Hystrix</th>
<th align="center">resilience4j</th>
</tr>
</thead>
<tbody><tr>
<td align="center">隔离策略</td>
<td align="center">信号量隔离（并发线程数限流）</td>
<td align="center">线程池隔离/信号量隔离</td>
<td align="center">信号量隔离</td>
</tr>
<tr>
<td align="center">熔断降级策略</td>
<td align="center">基于响应时间、异常比率、异常数</td>
<td align="center">基于异常比率</td>
<td align="center">基于异常比率、响应时间</td>
</tr>
<tr>
<td align="center">实时统计实现</td>
<td align="center">滑动窗口（LeapArray）</td>
<td align="center">滑动窗口（基于 RxJava）</td>
<td align="center">Ring Bit Buffer</td>
</tr>
<tr>
<td align="center">动态规则配置</td>
<td align="center">支持多种数据源</td>
<td align="center">支持多种数据源</td>
<td align="center">有限支持</td>
</tr>
<tr>
<td align="center">扩展性</td>
<td align="center">多个扩展点</td>
<td align="center">插件的形式</td>
<td align="center">接口的形式</td>
</tr>
<tr>
<td align="center">基于注解的支持</td>
<td align="center">支持</td>
<td align="center">支持</td>
<td align="center">支持</td>
</tr>
<tr>
<td align="center">限流</td>
<td align="center">基于 QPS，支持基于调用关系的限流</td>
<td align="center">有限的支持</td>
<td align="center">Rate Limiter</td>
</tr>
<tr>
<td align="center">流量整形</td>
<td align="center">支持预热模式、匀速器模式、预热排队模式</td>
<td align="center">不支持</td>
<td align="center">简单的 Rate Limiter 模式</td>
</tr>
<tr>
<td align="center">系统自适应保护</td>
<td align="center">支持</td>
<td align="center">不支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td align="center">控制台</td>
<td align="center">提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td>
<td align="center">简单的监控查看</td>
<td align="center">不提供控制台，可对接其它监控系统</td>
</tr>
</tbody></table>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://blog.csdn.net/peterwanghao/article/details/81509944" target="_blank" rel="noopener">微服务与断路器</a></li>
<li><a href="https://github.com/alibaba/Sentinel/wiki/Guideline:-%E4%BB%8E-Hystrix-%E8%BF%81%E7%A7%BB%E5%88%B0-Sentinel" target="_blank" rel="noopener">Guideline: 从 Hystrix 迁移到 Sentinel</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E5%85%AD)%20Custom%20Extend/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E5%85%AD)%20Custom%20Extend/" class="post-title-link" itemprop="url">Spring Cloud Gateway 开发指南（六） Custom Extend</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-27 21:26:00" itemprop="dateCreated datePublished" datetime="2020-02-27T21:26:00+08:00">2020-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="自定义-Route-Predicate-Factories"><a href="#自定义-Route-Predicate-Factories" class="headerlink" title="自定义 Route Predicate Factories"></a>自定义 Route Predicate Factories</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">CustomRoutePredicateFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomRoutePredicateFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Config<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(CustomRoutePredicateFactory.Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (GatewayPredicate) serverWebExchange -&gt; <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Put the configuration properties for your filter here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义-GatewayFilter-Factories"><a href="#自定义-GatewayFilter-Factories" class="headerlink" title="自定义 GatewayFilter Factories"></a>自定义 GatewayFilter Factories</h3><p>** Pre: **</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">PreGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PreGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Config<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// grab configuration from Config object</span></span><br><span class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">            <span class="comment">//If you want to build a "pre" filter you need to manipulate the</span></span><br><span class="line">            <span class="comment">//request before calling chain.filter</span></span><br><span class="line">            ServerHttpRequest.Builder builder = exchange.getRequest().mutate();</span><br><span class="line">            <span class="comment">//use builder to manipulate the request</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Put the configuration properties for your filter here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** Post: **</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">PostGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PostGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Config<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// grab configuration from Config object</span></span><br><span class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">                <span class="comment">//Manipulate the response in some way</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Put the configuration properties for your filter here</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义-Global-Filters"><a href="#自定义-Global-Filters" class="headerlink" title="自定义 Global Filters"></a>自定义 Global Filters</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public GlobalFilter customGlobalFilter() &#123;</span><br><span class="line">    return (exchange, chain) -&gt; exchange.getPrincipal()</span><br><span class="line">        .map(Principal::getName)</span><br><span class="line">        .defaultIfEmpty(&quot;Default User&quot;)</span><br><span class="line">        .map(userName -&gt; &#123;</span><br><span class="line">          &#x2F;&#x2F;adds header to proxied request</span><br><span class="line">          exchange.getRequest().mutate().header(&quot;CUSTOM-REQUEST-HEADER&quot;, userName).build();</span><br><span class="line">          return exchange;</span><br><span class="line">        &#125;)</span><br><span class="line">        .flatMap(chain::filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Bean</span><br><span class="line">public GlobalFilter customGlobalPostFilter() &#123;</span><br><span class="line">    return (exchange, chain) -&gt; chain.filter(exchange)</span><br><span class="line">        .then(Mono.just(exchange))</span><br><span class="line">        .map(serverWebExchange -&gt; &#123;</span><br><span class="line">          &#x2F;&#x2F;adds header to response</span><br><span class="line">          serverWebExchange.getResponse().getHeaders().set(&quot;CUSTOM-RESPONSE-HEADER&quot;,</span><br><span class="line">              HttpStatus.OK.equals(serverWebExchange.getResponse().getStatusCode()) ? &quot;It worked&quot;: &quot;It did not work&quot;);</span><br><span class="line">          return serverWebExchange;</span><br><span class="line">        &#125;)</span><br><span class="line">        .then();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">Spring Cloud Gateway</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E5%9B%9B)%20Configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E5%9B%9B)%20Configuration/" class="post-title-link" itemprop="url">Spring Cloud Gateway 开发指南（四） Configuration</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-27 20:35:00" itemprop="dateCreated datePublished" datetime="2020-02-27T20:35:00+08:00">2020-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Spring Cloud Gateway 的配置由 RouteDefinitionLocator 实例集合驱动。以下是 RouteDefinitionLocator 的接口定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouteDefinitionLocator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">Flux&lt;RouteDefinition&gt; <span class="title">getRouteDefinitions</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下，PropertiesRouteDefinitionLocator 通过使用 Spring Boot 的 @ConfigurationProperties 机制加载属性。</p>
<p>有两种方式可以配置：使用命名参数和使用带有位置参数的快捷符号。下面两个例子是等价的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setstatus_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SetStatus</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">status:</span> <span class="number">401</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setstatusshortcut_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetStatus=401</span></span><br></pre></td></tr></table></figure>
<p>对于网关的某些用法，属性配置是足够的，但是一些生产用例可以从外部源（如数据库）加载配置中获益。将来的里程碑版本将有基于 Spring 数据存储库（如Redis、MongoDB和Cassandra）的 RouteDefinitionLocator 实现。</p>
<h2 id="路由元数据配置"><a href="#路由元数据配置" class="headerlink" title="路由元数据配置"></a>路由元数据配置</h2><p>可以使用元数据为每个路由配置额外的参数，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route_with_metadata</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">optionName:</span> <span class="string">"OptionValue"</span></span><br><span class="line">          <span class="attr">compositeObject:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">"value"</span></span><br><span class="line">          <span class="attr">iAmNumber:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可以从 exchange 中获取所有元数据属性，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Route route = exchange.getAttribute(GATEWAY_ROUTE_ATTR);</span><br><span class="line"><span class="comment">// get all metadata properties</span></span><br><span class="line">route.getMetadata();</span><br><span class="line"><span class="comment">// get a single metadata property</span></span><br><span class="line">route.getMetadata(someKey);</span><br></pre></td></tr></table></figure>

<h2 id="HTTP-超时配置"><a href="#HTTP-超时配置" class="headerlink" title="HTTP 超时配置"></a>HTTP 超时配置</h2><p>可以为所有路由配置 Http 超时(响应和连接)，并覆盖每个特定路由。</p>
<h3 id="全局超时"><a href="#全局超时" class="headerlink" title="全局超时"></a>全局超时</h3><p>配置全局 Http 超时：</p>
<ul>
<li>必须以毫秒为单位指定连接超时</li>
<li>响应超时必须指定为 java.time.Duration</li>
</ul>
<p>全局 Http 超时示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">connect-timeout:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">response-timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>

<h3 id="单个路由超时"><a href="#单个路由超时" class="headerlink" title="单个路由超时"></a>单个路由超时</h3><p>配置单个路由超时：</p>
<ul>
<li>必须以毫秒为单位指定连接超时</li>
<li>响应超时必须以毫秒为单位指定</li>
</ul>
<p>单个路由的 Http 超时示例-配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">per_route_timeouts</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">/delay/&#123;timeout&#125;</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">response-timeout:</span> <span class="number">200</span></span><br><span class="line">    <span class="attr">connect-timeout:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p>单个路由的 Http 超时示例-Java DSL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.cloud.gateway.support.RouteMetadataUtils.CONNECT_TIMEOUT_ATTR;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.cloud.gateway.support.RouteMetadataUtils.RESPONSE_TIMEOUT_ATTR;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder routeBuilder)</span></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> routeBuilder.routes()</span><br><span class="line">       .route(<span class="string">"test1"</span>, r -&gt; &#123;</span><br><span class="line">          <span class="keyword">return</span> r.host(<span class="string">"*.somehost.org"</span>).and().path(<span class="string">"/somepath"</span>)</span><br><span class="line">                .filters(f -&gt; f.addRequestHeader(<span class="string">"header1"</span>, <span class="string">"header-value-1"</span>))</span><br><span class="line">                .uri(<span class="string">"http://someuri"</span>)</span><br><span class="line">                .metadata(RESPONSE_TIMEOUT_ATTR, <span class="number">200</span>)</span><br><span class="line">                .metadata(CONNECT_TIMEOUT_ATTR, <span class="number">200</span>);</span><br><span class="line">       &#125;)</span><br><span class="line">       .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Fluent-Java-路由-API"><a href="#Fluent-Java-路由-API" class="headerlink" title="Fluent Java 路由 API"></a>Fluent Java 路由 API</h3><p>为了允许在 Java 中进行简单配置，RouteLocatorBuilder bean 提供了 Fluent API。示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static imports from GatewayFilters and RoutePredicates</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder, ThrottleGatewayFilterFactory throttle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(r -&gt; r.host(<span class="string">"**.abc.org"</span>).and().path(<span class="string">"/image/png"</span>)</span><br><span class="line">                .filters(f -&gt;</span><br><span class="line">                        f.addResponseHeader(<span class="string">"X-TestHeader"</span>, <span class="string">"foobar"</span>))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">            )</span><br><span class="line">            .route(r -&gt; r.path(<span class="string">"/image/webp"</span>)</span><br><span class="line">                .filters(f -&gt;</span><br><span class="line">                        f.addResponseHeader(<span class="string">"X-AnotherHeader"</span>, <span class="string">"baz"</span>))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">                .metadata(<span class="string">"key"</span>, <span class="string">"value"</span>)</span><br><span class="line">            )</span><br><span class="line">            .route(r -&gt; r.order(-<span class="number">1</span>)</span><br><span class="line">                .host(<span class="string">"**.throttle.org"</span>).and().path(<span class="string">"/get"</span>)</span><br><span class="line">                .filters(f -&gt; f.filter(throttle.apply(<span class="number">1</span>,</span><br><span class="line">                        <span class="number">1</span>,</span><br><span class="line">                        <span class="number">10</span>,</span><br><span class="line">                        TimeUnit.SECONDS)))</span><br><span class="line">                .uri(<span class="string">"http://httpbin.org:80"</span>)</span><br><span class="line">                .metadata(<span class="string">"key"</span>, <span class="string">"value"</span>)</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种风格还允许使用更多的定制断言。RouteDefinitionLocator bean 定义的谓词列表使用逻辑 AND。通过使用 Fluent Java API，我们可以在类 Predicate 上使用 and()、or() 和 negate() 操作符。</p>
<h3 id="DiscoveryClient-路由定义-Locator"><a href="#DiscoveryClient-路由定义-Locator" class="headerlink" title="DiscoveryClient 路由定义 Locator"></a>DiscoveryClient 路由定义 Locator</h3><p>可以使用与 DiscoveryClient 兼容的服务注册中心里注册的服务来创建路由。</p>
<p>要启用此功能，需要设置 spring.cloud.gateway.discovery.locator.enabled=true，并确保类路径上有一个 DiscoveryClient(如 Netflix Eureka、或Zookeeper) 实现。</p>
<h3 id="为-DiscoveryClient-路由配置谓词和过滤器"><a href="#为-DiscoveryClient-路由配置谓词和过滤器" class="headerlink" title="为 DiscoveryClient 路由配置谓词和过滤器"></a>为 DiscoveryClient 路由配置谓词和过滤器</h3><p>默认情况下，网关为使用 DiscoveryClient 创建的路由定义单个谓词和过滤器。</p>
<p>默认谓词是使用模式 /serviceId/** 定义的路径谓词，其中 serviceId 是来自 DiscoveryClient 的服务的 ID。</p>
<p>默认的过滤器是一个重写路径过滤器，它使用正则表达式 /serviceId/(?<remaining>.*) 和替换的 /${remaining}。这将在请求向下游发送之前从路径中删除服务 ID。</p>
<p>如果希望自定义 DiscoveryClient 路由使用的谓词或过滤器，需设置 spring.cloud.gateway.discovery.locator.predicates[x] 和 spring.cloud.gateway.discovery.locator.filters[y]。这样做时，如果希望保留该功能，则需要确保包含前面显示的缺省谓词和筛选器。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.predicates[0].name:</span> <span class="string">Path</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.predicates[0].args[pattern]:</span> <span class="string">"'/'+serviceId+'/**'"</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.predicates[1].name:</span> <span class="string">Host</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.predicates[1].args[pattern]:</span> <span class="string">"'**.foo.com'"</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.filters[0].name:</span> <span class="string">Hystrix</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.filters[0].args[name]:</span> <span class="string">serviceId</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.filters[1].name:</span> <span class="string">RewritePath</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.filters[1].args[regexp]:</span> <span class="string">"'/' + serviceId + '/(?&lt;remaining&gt;.*)'"</span></span><br><span class="line"><span class="string">spring.cloud.gateway.discovery.locator.filters[1].args[replacement]:</span> <span class="string">"'/$&#123;remaining&#125;'"</span></span><br></pre></td></tr></table></figure>

<h2 id="CORS-配置"><a href="#CORS-配置" class="headerlink" title="CORS 配置"></a>CORS 配置</h2><p>可以配置网关来控制 CORS 行为。全局 CORS 配置是 Spring Framework CorsConfiguration 的 URL 模式映射。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">'[/**]'</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="string">"https://docs.spring.io"</span></span><br><span class="line">            <span class="attr">allowedMethods:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">GET</span></span><br></pre></td></tr></table></figure>

<p>在前面的示例中，CORS 请求允许来自 docs.spring.io 的所有 GET 请求路径。</p>
<p>要为某些网关路由谓词不能处理的请求提供相同的 CORS 配置，需设置 spring.cloud.gateway.globalcors.add-to-simple-url-handler-mapping=true。当我们试图支持 CORS preflight 请求时，这是很有用的，因为 HTTP 方法是 options，所以路由谓词不为 true。</p>
<h2 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h2><p>下面的 loggers 可能包含在 DEBUG 和 TRACE 级别上有价值的故障排除信息。</p>
<ul>
<li>org.springframework.cloud.gateway</li>
<li>org.springframework.http.server.reactive</li>
<li>org.springframework.web.reactive</li>
<li>org.springframework.boot.autoconfigure.web</li>
<li>reactor.netty</li>
<li>redisratelimiter</li>
</ul>
<h2 id="TLS-和-SSL"><a href="#TLS-和-SSL" class="headerlink" title="TLS 和 SSL"></a>TLS 和 SSL</h2><p>网关可以通过 Spring server 配置来监听 HTTPS 请求。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">ssl:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">key-alias:</span> <span class="string">scg</span></span><br><span class="line">    <span class="attr">key-store-password:</span> <span class="string">scg1234</span></span><br><span class="line">    <span class="attr">key-store:</span> <span class="string">classpath:scg-keystore.p12</span></span><br><span class="line">    <span class="attr">key-store-type:</span> <span class="string">PKCS12</span></span><br></pre></td></tr></table></figure>

<p>可以将网关路由路由到 HTTP 和 HTTPS 后端。如果是路由到一个 HTTPS 后端，可以使用下面的配置使得网关信任所有下游证书：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">ssl:</span></span><br><span class="line">          <span class="attr">useInsecureTrustManager:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>使用不安全的信任管理器不适合生产环境。对于产品部署，可以使用一组已知的证书配置网关，网关可以通过以下配置信任这些证书：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">ssl:</span></span><br><span class="line">          <span class="attr">trustedX509Certificates:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">cert1.pem</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">cert2.pem</span></span><br></pre></td></tr></table></figure>

<p>如果 Spring Cloud Gateway 没有提供受信任的证书，则使用默认的信任存储区（可以通过设置 javax.net.ssl.trustStore 系统属性来覆盖该存储区）。</p>
<h3 id="TLS-握手"><a href="#TLS-握手" class="headerlink" title="TLS 握手"></a>TLS 握手</h3><p>网关维护一个用于路由到后端的客户端池。当通过 HTTPS 通信时，客户端发起 TLS 握手。许多超时都与此握手相关。可以使用下面的配置来调整超时配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">ssl:</span></span><br><span class="line">          <span class="attr">handshake-timeout-millis:</span> <span class="number">10000</span></span><br><span class="line">          <span class="attr">close-notify-flush-timeout-millis:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">close-notify-read-timeout-millis:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">Spring Cloud Gateway</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E4%BA%94)%20Actuator%20API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E4%BA%94)%20Actuator%20API/" class="post-title-link" itemprop="url">Spring Cloud Gateway 开发指南（五） Actuator API</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-27 18:16:00" itemprop="dateCreated datePublished" datetime="2020-02-27T18:16:00+08:00">2020-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我们可以通过 /gateway actuator 端点来监控 Spring Cloud Gateway 应用程序并与之交互。不过要进行远程访问，必须在应用程序配置属性中启用该端点并将其暴露在 HTTP 或 JMX 上。配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 默认已开启</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="comment"># 默认只暴露了 health/info 端点</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">health,info,gateway</span></span><br></pre></td></tr></table></figure>

<h2 id="详细的-Actuator-格式"><a href="#详细的-Actuator-格式" class="headerlink" title="详细的 Actuator 格式"></a>详细的 Actuator 格式</h2><p>Spring Cloud Gateway 增加了一种新的、更详细的格式。它为每个路由添加了更多的细节，允许我们查看与每个路由关联的谓词和过滤器，以及任何可用的配置。</p>
<p>例如，当我们访问端点 <strong>/actuator/gateway/routes</strong> 时，会得到类似以下响应内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">	<span class="attr">"predicate"</span>: <span class="string">"Paths: [/api-seckill/**], match trailing slash: true"</span>,</span><br><span class="line">	<span class="attr">"route_id"</span>: <span class="string">"seckill"</span>,</span><br><span class="line">	<span class="attr">"filters"</span>: [<span class="string">"[[StripPrefix parts = 1], order = 1]"</span>, <span class="string">"[org.springframework.cloud.gateway.filter.factory.RequestRateLimiterGatewayFilterFactory$$Lambda$775/831609821@27b48b61, order = 2]"</span>, <span class="string">"[[SpringCloudCircuitBreakerResilience4JFilterFactory name = 'circuitBreaker', fallback = forward:/fallback], order = 3]"</span>],</span><br><span class="line">	<span class="attr">"uri"</span>: <span class="string">"http://localhost:8081"</span>,</span><br><span class="line">	<span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="attr">"predicate"</span>: <span class="string">"(Paths: [/api-account/**], match trailing slash: true &amp;&amp; gateway.routepredicatefactories.CustomRoutePredicateFactory$$Lambda$781/1730708228@7785ff79)"</span>,</span><br><span class="line">	<span class="attr">"route_id"</span>: <span class="string">"account"</span>,</span><br><span class="line">	<span class="attr">"filters"</span>: [<span class="string">"[[StripPrefix parts = 1], order = 1]"</span>, <span class="string">"[gateway.gatewayfilterfactories.CustomPreGatewayFilterFactory$$Lambda$783/509794966@14af153d, order = 1]"</span>, <span class="string">"[org.springframework.cloud.gateway.filter.factory.RequestRateLimiterGatewayFilterFactory$$Lambda$775/831609821@71ece0cb, order = 2]"</span>, <span class="string">"[gateway.gatewayfilterfactories.CustomPostGatewayFilterFactory$$Lambda$785/1358748845@72809214, order = 2]"</span>, <span class="string">"[[SpringCloudCircuitBreakerResilience4JFilterFactory name = 'circuitBreaker', fallback = forward:/fallback], order = 3]"</span>],</span><br><span class="line">	<span class="attr">"uri"</span>: <span class="string">"http://localhost:8082"</span>,</span><br><span class="line">	<span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>默认情况下启用此功能。要禁用它，可以设置以下属性：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cloud.gateway.actuator.verbose.enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="检索路由过滤器"><a href="#检索路由过滤器" class="headerlink" title="检索路由过滤器"></a>检索路由过滤器</h2><p>本节详细介绍如何检索路由过滤器，包括：</p>
<ul>
<li>全局过滤器</li>
<li>路由过滤器</li>
</ul>
<h3 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h3><p>要检索应用于所有路由的全局过滤器，需向端点 <strong>/actuator/gateway/globalfilters</strong> 发送 GET 请求。得到的响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.RemoveCachedBodyFilter@217235f5"</span>: <span class="number">-2147483648</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter@64502326"</span>: <span class="number">-2147482648</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.GatewayMetricsFilter@697a0948"</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.NettyWriteResponseFilter@79957f11"</span>: <span class="number">-1</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.WebsocketRoutingFilter@28393e82"</span>: <span class="number">2147483646</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.ForwardPathFilter@18d47df0"</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="attr">"gateway.globalfilters.ElapsedGlobalFilter@2dd1086"</span>: <span class="number">-2147483648</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter@4b41587d"</span>: <span class="number">10000</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.config.GatewayNoLoadBalancerClientAutoConfiguration$NoLoadBalancerClientFilter@7cf63b9a"</span>: <span class="number">10100</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.ForwardRoutingFilter@4aebee4b"</span>: <span class="number">2147483647</span>,</span><br><span class="line">	<span class="attr">"org.springframework.cloud.gateway.filter.NettyRoutingFilter@6b8d54da"</span>: <span class="number">2147483647</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应包含已生效的全局过滤器的详细信息。对于每个全局过滤器，有一个过滤器对象的字符串表示（例如，org.springframework.cloud.gateway.filter.LoadBalancerClientFilter@7cf63b9a）和过滤器链中相应的顺序。</p>
<h3 id="路由过滤器"><a href="#路由过滤器" class="headerlink" title="路由过滤器"></a>路由过滤器</h3><p>要检索应用于路由的 GatewayFilter 工厂，需向端点 /actuator/gateway/routefilters 发送 GET 请求。得到的响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"[SetPathGatewayFilterFactory@26c8b296 configClass = SetPathGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[PreserveHostHeaderGatewayFilterFactory@1edccfd4 configClass = Object]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RewriteLocationResponseHeaderGatewayFilterFactory@45801322 configClass = RewriteLocationResponseHeaderGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RemoveRequestHeaderGatewayFilterFactory@1efac5b9 configClass = AbstractGatewayFilterFactory.NameConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RequestSizeGatewayFilterFactory@5b1e88f configClass = RequestSizeGatewayFilterFactory.RequestSizeConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[DedupeResponseHeaderGatewayFilterFactory@1d2fb82 configClass = DedupeResponseHeaderGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[AddRequestParameterGatewayFilterFactory@76c86567 configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[SaveSessionGatewayFilterFactory@3520958b configClass = Object]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RequestRateLimiterGatewayFilterFactory@40df6090 configClass = RequestRateLimiterGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RedirectToGatewayFilterFactory@8c43966 configClass = RedirectToGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RemoveRequestParameterGatewayFilterFactory@11a3a45f configClass = AbstractGatewayFilterFactory.NameConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RequestHeaderToRequestUriGatewayFilterFactory@291a4791 configClass = AbstractGatewayFilterFactory.NameConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[CustomPostGatewayFilterFactory@5a05dd30 configClass = CustomPostGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[StripPrefixGatewayFilterFactory@6cc64028 configClass = StripPrefixGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[ModifyRequestBodyGatewayFilterFactory@5a4dda2 configClass = ModifyRequestBodyGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RetryGatewayFilterFactory@44d7e24 configClass = RetryGatewayFilterFactory.RetryConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[ModifyResponseBodyGatewayFilterFactory@34045582 configClass = ModifyResponseBodyGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RequestHeaderSizeGatewayFilterFactory@340cb97f configClass = RequestHeaderSizeGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[FallbackHeadersGatewayFilterFactory@11c88cca configClass = FallbackHeadersGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[SpringCloudCircuitBreakerResilience4JFilterFactory@6a1568d6 configClass = SpringCloudCircuitBreakerFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[SecureHeadersGatewayFilterFactory@1d289d3f configClass = Object]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[SetResponseHeaderGatewayFilterFactory@7f27f59b configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[PrefixPathGatewayFilterFactory@3db65c0d configClass = PrefixPathGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RewritePathGatewayFilterFactory@8c0a23f configClass = RewritePathGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RemoveResponseHeaderGatewayFilterFactory@69796bd0 configClass = AbstractGatewayFilterFactory.NameConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[MapRequestHeaderGatewayFilterFactory@250d440 configClass = MapRequestHeaderGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[AddRequestHeaderGatewayFilterFactory@dbed7fd configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[AddResponseHeaderGatewayFilterFactory@7e5efcab configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[CustomPreGatewayFilterFactory@1b52699c configClass = CustomPreGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[SetRequestHeaderGatewayFilterFactory@10f405ff configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[RewriteResponseHeaderGatewayFilterFactory@1c98b4eb configClass = RewriteResponseHeaderGatewayFilterFactory.Config]"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="attr">"[SetStatusGatewayFilterFactory@756b2d90 configClass = SetStatusGatewayFilterFactory.Config]"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应包含应用于任何特定路由的 GatewayFilter 工厂的详细信息。每个工厂都有对应对象的字符串表示(例如，[SecureHeadersGatewayFilterFactory@1d289d3f configClass = object])。注意，null 值是由于端点控制器的实现不完整造成的，因为它试图在过滤器链中设置对象的顺序，而这并不适用于 GatewayFilter 工厂对象。</p>
<h2 id="刷新路由缓存"><a href="#刷新路由缓存" class="headerlink" title="刷新路由缓存"></a>刷新路由缓存</h2><p>若要清除路由缓存，需向端点 <strong>/actuator/gateway/refresh</strong> 发送 POST 请求。请求返回一个没有响应体的 200。</p>
<h2 id="检索网关中定义的路由"><a href="#检索网关中定义的路由" class="headerlink" title="检索网关中定义的路由"></a>检索网关中定义的路由</h2><p>要检索网关中定义的路由，需向端点 /actuator/gateway/routes 发送 GET 请求。得到的响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">	<span class="attr">"predicate"</span>: <span class="string">"Paths: [/api-seckill/**], match trailing slash: true"</span>,</span><br><span class="line">	<span class="attr">"route_id"</span>: <span class="string">"seckill"</span>,</span><br><span class="line">	<span class="attr">"filters"</span>: [<span class="string">"[[StripPrefix parts = 1], order = 1]"</span>, <span class="string">"[org.springframework.cloud.gateway.filter.factory.RequestRateLimiterGatewayFilterFactory$$Lambda$775/831609821@27b48b61, order = 2]"</span>, <span class="string">"[[SpringCloudCircuitBreakerResilience4JFilterFactory name = 'circuitBreaker', fallback = forward:/fallback], order = 3]"</span>],</span><br><span class="line">	<span class="attr">"uri"</span>: <span class="string">"http://localhost:8081"</span>,</span><br><span class="line">	<span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="attr">"predicate"</span>: <span class="string">"(Paths: [/api-account/**], match trailing slash: true &amp;&amp; gateway.routepredicatefactories.CustomRoutePredicateFactory$$Lambda$781/1730708228@7785ff79)"</span>,</span><br><span class="line">	<span class="attr">"route_id"</span>: <span class="string">"account"</span>,</span><br><span class="line">	<span class="attr">"filters"</span>: [<span class="string">"[[StripPrefix parts = 1], order = 1]"</span>, <span class="string">"[gateway.gatewayfilterfactories.CustomPreGatewayFilterFactory$$Lambda$783/509794966@14af153d, order = 1]"</span>, <span class="string">"[org.springframework.cloud.gateway.filter.factory.RequestRateLimiterGatewayFilterFactory$$Lambda$775/831609821@71ece0cb, order = 2]"</span>, <span class="string">"[gateway.gatewayfilterfactories.CustomPostGatewayFilterFactory$$Lambda$785/1358748845@72809214, order = 2]"</span>, <span class="string">"[[SpringCloudCircuitBreakerResilience4JFilterFactory name = 'circuitBreaker', fallback = forward:/fallback], order = 3]"</span>],</span><br><span class="line">	<span class="attr">"uri"</span>: <span class="string">"http://localhost:8082"</span>,</span><br><span class="line">	<span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>响应包含网关中定义的所有路由的详细信息。下表描述了响应的每个元素(每个都是一个路由)的结构：</p>
<table>
<thead>
<tr>
<th align="center">属性名</th>
<th align="center">属性类型</th>
<th align="center">属性描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">route_id</td>
<td align="center">String</td>
<td align="center">The route ID.</td>
</tr>
<tr>
<td align="center">predicate</td>
<td align="center">Object</td>
<td align="center">The route predicate.</td>
</tr>
<tr>
<td align="center">filters</td>
<td align="center">Array</td>
<td align="center">The GatewayFilter factories applied to the route.</td>
</tr>
<tr>
<td align="center">uri</td>
<td align="center">String</td>
<td align="center">The destination URI of the route..</td>
</tr>
<tr>
<td align="center">order</td>
<td align="center">Number</td>
<td align="center">The route order.</td>
</tr>
</tbody></table>
<h2 id="检索指定定路由的信息"><a href="#检索指定定路由的信息" class="headerlink" title="检索指定定路由的信息"></a>检索指定定路由的信息</h2><p>要检索关于单个路由的信息，需向端点 /actuator/gateway/routes/{id} 发送 GET 请求（例如，/actuator/gateway/routes/account）。得到的响应类似于以下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"predicate"</span>: <span class="string">"(Paths: [/api-account/**], match trailing slash: true &amp;&amp; gateway.routepredicatefactories.CustomRoutePredicateFactory$$Lambda$781/1730708228@7785ff79)"</span>,</span><br><span class="line">	<span class="attr">"route_id"</span>: <span class="string">"account"</span>,</span><br><span class="line">	<span class="attr">"filters"</span>: [<span class="string">"[[StripPrefix parts = 1], order = 1]"</span>, <span class="string">"[gateway.gatewayfilterfactories.CustomPreGatewayFilterFactory$$Lambda$783/509794966@14af153d, order = 1]"</span>, <span class="string">"[org.springframework.cloud.gateway.filter.factory.RequestRateLimiterGatewayFilterFactory$$Lambda$775/831609821@71ece0cb, order = 2]"</span>, <span class="string">"[gateway.gatewayfilterfactories.CustomPostGatewayFilterFactory$$Lambda$785/1358748845@72809214, order = 2]"</span>, <span class="string">"[[SpringCloudCircuitBreakerResilience4JFilterFactory name = 'circuitBreaker', fallback = forward:/fallback], order = 3]"</span>],</span><br><span class="line">	<span class="attr">"uri"</span>: <span class="string">"http://localhost:8082"</span>,</span><br><span class="line">	<span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下表描述了响应的结构：</p>
<table>
<thead>
<tr>
<th align="center">属性名</th>
<th align="center">属性类型</th>
<th align="center">属性描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">route_id</td>
<td align="center">String</td>
<td align="center">The route ID.</td>
</tr>
<tr>
<td align="center">predicate</td>
<td align="center">Object</td>
<td align="center">The route predicate.</td>
</tr>
<tr>
<td align="center">filters</td>
<td align="center">Array</td>
<td align="center">The GatewayFilter factories applied to the route.</td>
</tr>
<tr>
<td align="center">uri</td>
<td align="center">String</td>
<td align="center">The destination URI of the route..</td>
</tr>
<tr>
<td align="center">order</td>
<td align="center">Number</td>
<td align="center">The route order.</td>
</tr>
</tbody></table>
<h2 id="创建和删除指定路由"><a href="#创建和删除指定路由" class="headerlink" title="创建和删除指定路由"></a>创建和删除指定路由</h2><p>要创建路由，需向端点 /gateway/routes/{id_route_to_create} 发送 POST 请求并携带 JSON body。JSON body 类似于以下内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="string">"first_route"</span>,</span><br><span class="line">  <span class="attr">"predicates"</span>: [&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Path"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: &#123;<span class="attr">"_genkey_0"</span>:<span class="string">"/first"</span>&#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">"filters"</span>: [],</span><br><span class="line">  <span class="attr">"uri"</span>: <span class="string">"https://www.uri-destination.org"</span>,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<p>要删除路由，需向端点 /gateway/routes/{id_route_to_delete} 发送 DELETE 请求。</p>
<h2 id="重述：所有端点列表"><a href="#重述：所有端点列表" class="headerlink" title="重述：所有端点列表"></a>重述：所有端点列表</h2><p>下面的表格总结了 Spring Cloud Gateway actuator 的所有端点(注意每个端点都有 /actuator/gateway 作为基本路径)：</p>
<table>
<thead>
<tr>
<th align="center">ID</th>
<th align="center">HTTP Method</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">globalfilters</td>
<td align="center">GET</td>
<td align="center">Displays the list of global filters applied to the routes.</td>
</tr>
<tr>
<td align="center">routefilters</td>
<td align="center">GET</td>
<td align="center">Displays the list of GatewayFilter factories applied to a particular route.</td>
</tr>
<tr>
<td align="center">refresh</td>
<td align="center">POST</td>
<td align="center">Clears the routes cache.</td>
</tr>
<tr>
<td align="center">routes</td>
<td align="center">GET</td>
<td align="center">Displays the list of routes defined in the gateway.</td>
</tr>
<tr>
<td align="center">routes/{id}</td>
<td align="center">GET</td>
<td align="center">Displays information about a particular route.</td>
</tr>
<tr>
<td align="center">routes/{id}</td>
<td align="center">POST</td>
<td align="center">Adds a new route to the gateway.</td>
</tr>
<tr>
<td align="center">routes/{id}</td>
<td align="center">DELETE</td>
<td align="center">Removes an existing route from the gateway.</td>
</tr>
</tbody></table>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">Spring Cloud Gateway</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E4%B8%89)%20Global%20Filters/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E4%B8%89)%20Global%20Filters/" class="post-title-link" itemprop="url">Spring Cloud Gateway 开发指南（三） Global Filters</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-27 11:44:00" itemprop="dateCreated datePublished" datetime="2020-02-27T11:44:00+08:00">2020-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>GlobalFilter 接口具有与 GatewayFilter 接相同的签名。这些特殊的过滤器可以有条件的应用于所有的路由。（这些接口和用法在以后的版本中可能会被修改）</p>
<h2 id="Combined-Global过滤器and-GatewayFilter-Ordering"><a href="#Combined-Global过滤器and-GatewayFilter-Ordering" class="headerlink" title="Combined Global过滤器and GatewayFilter Ordering"></a>Combined Global过滤器and GatewayFilter Ordering</h2><p>当请求与路由匹配时，filtering web handler 会加载所有的 GlobalFilter 实例以及这个路由上配置的所有的 GatewayFilter，然后组成一个完整的过滤器链。这个合并的过滤器链使用 org.springframework.core.Ordered 接口进行排序，可以通过实现 Ordered 接口中的 getOrder() 方法（或直接使用 @Order 注解）修改过滤器的顺序。</p>
<p>由于 Spring Cloud Gateway 分开执行 “pre” 和 “post” 的过滤器，因此优先级最高的过滤器是 “pre” 阶段的第一个过滤器，是 “post” 阶段的最后一个过滤器。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">customFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomGlobalFilter();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"custom global filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Forward-Routing-Filter"><a href="#Forward-Routing-Filter" class="headerlink" title="Forward Routing Filter"></a>Forward Routing Filter</h2><p>此过滤器在 exchange 的 ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR 属性中查找 URI。如果这个 URI 是 forward 模式（如 forward:///localendpoint），则使用 Spring DispatcherHandler 处理请求。请求 URL 的路径部分被转发 URL 中的路径覆盖。未修改的原始 URL 被附加到 ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR 属性中。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">forward_routing_filter</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">forward:///app</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/forwardFilter</span></span><br></pre></td></tr></table></figure>

<h2 id="LoadBalancerClient-Filter"><a href="#LoadBalancerClient-Filter" class="headerlink" title="LoadBalancerClient Filter"></a>LoadBalancerClient Filter</h2><p>此过滤器在 exchange 的 ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR 属性中查找 URI。如果这个 URI 是 lb 模式（如 lb:///myservice），则使用 Spring Cloud LoadBalancerClient 将名称(本例中为 myservice)解析为实际的主机和端口，并替换相同属性中的 URI。未修改的原始 URL 被附加到 ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR 属性中。此过滤器也会查看 exchange 的 ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR 属性值否等于 lb。如果是，则应用相同的规则。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">myRoute</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://service</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/service/**</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，当在 LoadBalancer 中找不到服务实例时，将返回一个 503。可以通过设置 spring.cloud.gateway.loadbalancer.use404=true 来配置网关以返回 404。</p>
<p>从 LoadBalancer 返回的 ServiceInstance 的 isSecure 值，会覆盖向网关发出的请求中指定的 scheme。例如，如果请求通过 HTTPS 进入网关，但 ServiceInstance 表明它不安全，则下游请求通过 HTTP 发出。相反的情况也适用。但是，如果网关配置中为路由指定了 GATEWAY_SCHEME_PREFIX_ATTR 属性，则删除前缀，路由 URL 的结果方案将覆盖 ServiceInstance 配置。</p>
<h2 id="ReactiveLoadBalancerClientFilter"><a href="#ReactiveLoadBalancerClientFilter" class="headerlink" title="ReactiveLoadBalancerClientFilter"></a>ReactiveLoadBalancerClientFilter</h2><p>此过滤器在 exchange 的 ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR 属性中查找 URI。如果这个 URI 是 lb 模式（如 lb:///myservice），则使用 Spring Cloud ReactorLoadBalancer 将名称(本例中为 myservice)解析为实际的主机和端口，并替换相同属性中的 URI。未修改的原始 URL 被附加到 ServerWebExchangeUtils.GATEWAY_ORIGINAL_REQUEST_URL_ATTR 属性中。此过滤器也会查看 exchange 的 ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR 属性值否等于 lb。如果是，则应用相同的规则。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">myRoute</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://service</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/service/**</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，当在 ReactorLoadBalancer 中找不到服务实例时，将返回一个 503。可以通过设置 spring.cloud.gateway.loadbalancer.use404=true 来配置网关以返回 404。</p>
<p>从 ReactiveLoadBalancerClientFilter 返回的 ServiceInstance 的 isSecure 值，会覆盖向网关发出的请求中指定的 scheme。例如，如果请求通过 HTTPS 进入网关，但 ServiceInstance 表明它不安全，则下游请求通过 HTTP 发出。相反的情况也适用。但是，如果网关配置中为路由指定了 GATEWAY_SCHEME_PREFIX_ATTR 属性，则删除前缀，路由 URL 的结果方案将覆盖 ServiceInstance 配置。</p>
<h2 id="Netty-Routing-Filter"><a href="#Netty-Routing-Filter" class="headerlink" title="Netty Routing Filter"></a>Netty Routing Filter</h2><p>当从 exchange 的 ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR 属性中获取的 URL 的 scheme 是 https 或 http 时，此过滤器生效。它使用 Netty 的 HttpClient 发出下游代理请求，请求返回的结果将存储在 exchange 的 ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR 属性中，过滤器链后面的过滤器可以从中获取返回的结果。（还有一个实验性的 filter:WebClientHttpRoutingFilter，它和 NettyRoutingFilter 的功能一样，但是不使用 netty。）</p>
<h2 id="Netty-Write-Response-Filter"><a href="#Netty-Write-Response-Filter" class="headerlink" title="Netty Write Response Filter"></a>Netty Write Response Filter</h2><p>当 exchange 的 ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR 属性中存在 HttpClientResponse 时，此过滤器生效。它在所有的其它的过滤器执行完成之后运行，将响应的数据发送给网关的客户端。 (还有一个实验性的 filter:WebClientWriteResponseFilter，它和 NettyWriteResponseFilter 的功能一样，但是不使用 netty。)</p>
<h2 id="RouteToRequestUrl-Filter"><a href="#RouteToRequestUrl-Filter" class="headerlink" title="RouteToRequestUrl Filter"></a>RouteToRequestUrl Filter</h2><p>当 exchange 的 ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR 属性中有一个路由对象时，此过滤器生效。它根据请求的 URI 创建一个新的 URI，但使用路由对象的 URI 属性进行更新。新的 URI 存放在 exchange 的 ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR 属性中。</p>
<p>如果 URI 有一个 scheme 前缀，例如 lb:ws://serviceid，则从 URI 中剥离 lb 模式并将其放入 ServerWebExchangeUtils.GATEWAY_SCHEME_PREFIX_ATTR 属性中，稍后在过滤器链中使用。</p>
<h2 id="The-Websocket-Routing-Filter"><a href="#The-Websocket-Routing-Filter" class="headerlink" title="The Websocket Routing Filter"></a>The Websocket Routing Filter</h2><p>当位于 excahnge 的 ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATT 属性中的 URL 有一个 ws 或 wss scheme 时，此过滤器生效。它使用 Spring WebSocket 基础设施将 WebSocket 请求转发到下游。</p>
<p>可以通过在 URI 前面加上 lb 来实现负载平衡，比如 lb:ws://serviceid。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="comment"># SockJS route</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">websocket_sockjs_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:3001</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/websocket/info/**</span></span><br><span class="line">      <span class="comment"># Normal Websocket route</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">websocket_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">ws://localhost:3001</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/websocket/**</span></span><br></pre></td></tr></table></figure>

<h2 id="The-Gateway-Metrics-Filter"><a href="#The-Gateway-Metrics-Filter" class="headerlink" title="The Gateway Metrics Filter"></a>The Gateway Metrics Filter</h2><p>要启用网关指标，添加 spring-boot-starter-actuator 作为项目依赖项。<br>在默认情况下，只有属性 spring.cloud.gateway.metrics.enabled 不是 false，此过滤器就会生效。此过滤器会添加一个名字为 gateway.requests 和 tags 为如下的 timer metric：</p>
<ul>
<li>routeId 路由的 ID</li>
<li>routeUri 被路由的的 URI</li>
<li>outcome 被 HttpStatus.Series 标记的结果</li>
<li>status 返回给客户端的 HTTP 状态码</li>
<li>httpStatusCode 返回给客户端的 HTTP 状态码</li>
<li>httpMethod 请求使用的 HTTP 方法</li>
</ul>
<p>可以通过 /actuator/metrics/gateway.requests 提取这些指标，这些指标可以很容易地与 Prometheus 集成，以创建一个 Grafana dashboard。</p>
<p>要启用 prometheus endpoint，添加 micrometer-registry-prometheus 作为项目依赖项。</p>
<h2 id="Marking-An-Exchange-As-Routed"><a href="#Marking-An-Exchange-As-Routed" class="headerlink" title="Marking An Exchange As Routed"></a>Marking An Exchange As Routed</h2><p>如果网关已经路由过一个 ServerWebExchange，它将标记这个 exchange 已经被路由过，记录在 exchange 的 ServerWebExchangeUtils.GATEWAY_ALREADY_ROUTED_ATTR 属性中。一旦被标记完成了路由，其它的路由过滤器将不会再路由本次请求，直接跳过此过滤器。有两个方便的方法，可以使用它们标记已路由过或检测是否已路由过。</p>
<ul>
<li>ServerWebExchangeUtils.isAlreadyRouted takes a ServerWebExchange object and checks if it has been “routed”</li>
<li>ServerWebExchangeUtils.setAlreadyRouted takes a ServerWebExchange object and marks it as “routed”</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">Spring Cloud Gateway</a></li>
<li><a href="https://www.cnblogs.com/wgslucky/p/11632572.html" target="_blank" rel="noopener">Spring Gateway 全局过滤器 Global Filters</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E4%BA%8C)%20GatewayFilter%20Factories/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/27/Spring%20Cloud%20Gateway%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97(%E4%BA%8C)%20GatewayFilter%20Factories/" class="post-title-link" itemprop="url">Spring Cloud Gateway 开发指南（二） GatewayFilter Factories</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-27 11:33:00" itemprop="dateCreated datePublished" datetime="2020-02-27T11:33:00+08:00">2020-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-06 15:11:29" itemprop="dateModified" datetime="2021-05-06T15:11:29+08:00">2021-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>路由过滤器允许以某种方式修改传入的 HTTP 请求或返回的 HTTP 响应。路由过滤器的作用域是特定的路由。Spring Cloud Gateway 包含许多内置的 GatewayFilter Factories。</p>
<h2 id="AddRequestHeader"><a href="#AddRequestHeader" class="headerlink" title="AddRequestHeader"></a>AddRequestHeader</h2><p>接受名称和值两个参数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-red,</span> <span class="string">blue</span></span><br></pre></td></tr></table></figure>

<p>这将为所有匹配的请求在下游请求的 headers 中添加 header X-Request-red:blue。</p>
<p>AddRequestHeader 知道用于匹配路径或主机的 URI 变量。URI 变量可以在值中使用，并在运行时展开。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/red/&#123;segment&#125;</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-Red,</span> <span class="string">Blue-&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="AddRequestParameter"><a href="#AddRequestParameter" class="headerlink" title="AddRequestParameter"></a>AddRequestParameter</h2><p>接受名称和值两个参数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_parameter_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestParameter=red,</span> <span class="string">blue</span></span><br></pre></td></tr></table></figure>

<p>这将为所有匹配的请求在下游请求的查询字符串中添加 red=blue。</p>
<p>AddRequestParameter 知道用于匹配路径或主机的 URI 变量。URI 变量可以在值中使用，并在运行时展开。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_parameter_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Host:</span> <span class="string">&#123;segment&#125;.myhost.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestParameter=foo,</span> <span class="string">bar-&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="AddResponseHeader"><a href="#AddResponseHeader" class="headerlink" title="AddResponseHeader"></a>AddResponseHeader</h2><p>接受名称和值两个参数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_response_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Red,</span> <span class="string">Blue</span></span><br></pre></td></tr></table></figure>

<p>这将为所有匹配的请求在下游响应的 headers 中添加 header X-Response-Red:Blue。</p>
<p>AddResponseHeader 知道用于匹配路径或主机的 URI 变量。URI 变量可以在值中使用，并在运行时展开。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_response_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Host:</span> <span class="string">&#123;segment&#125;.myhost.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddResponseHeader=foo,</span> <span class="string">bar-&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="DedupeResponseHeader"><a href="#DedupeResponseHeader" class="headerlink" title="DedupeResponseHeader"></a>DedupeResponseHeader</h2><p>接受名称参数和可选策略参数。名称可以包含以空格分隔的 header 名列表。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">dedupe_response_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">DedupeResponseHeader=Access-Control-Allow-Credentials</span> <span class="string">Access-Control-Allow-Origin</span></span><br></pre></td></tr></table></figure>

<p>当网关 CORS 逻辑和下游逻辑都添加它们时，这将从相应的 headers 中移除重复的 Access-Control-Allow-Credentials 和 Access-Control-Allow-Origin。</p>
<p>DedupeResponseHeader 过滤器也接受一个可选的策略参数。接受的值是 RETAIN_FIRST(默认值)、RETAIN_LAST 和 RETAIN_UNIQUE。</p>
<h2 id="Spring-Cloud-CircuitBreaker"><a href="#Spring-Cloud-CircuitBreaker" class="headerlink" title="Spring Cloud CircuitBreaker"></a>Spring Cloud CircuitBreaker</h2><p>此过滤器使用 Spring Cloud CircuitBreaker API 将 Gateway 路由封装在断路器中。Spring Cloud CircuitBreaker 支持两个可与 Spring Cloud Gateway 一起使用的库，即 Hystrix 和 Resilience4J。由于 Netflix 将 Hystrix 置于仅维护模式，建议大家使用 Resilience4J。</p>
<p>要启用此 filter，需要将 spring-cloud-starter-circuitbreaker-reactor-resilience4j 或 spring-cloud-starter-netflix-hystrix 置于类路径中。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">circuitbreaker_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">CircuitBreaker=myCircuitBreaker</span></span><br></pre></td></tr></table></figure>

<p>要配置断路器，请参阅所使用的断路器实现的配置。</p>
<ul>
<li><a href="https://cloud.spring.io/spring-cloud-circuitbreaker/reference/html/spring-cloud-circuitbreaker.html" target="_blank" rel="noopener">Resilience4J 文档</a></li>
<li><a href="https://cloud.spring.io/spring-cloud-netflix/reference/html/" target="_blank" rel="noopener">Hystrix 文档</a></li>
</ul>
<p>此过滤器也可以接受一个可选的 fallbackUri 参数。目前仅支持转发：支持 schemed URIs。如果调用了 fallback，请求将被转发给 URI 匹配的 controller。下面的示例配置了这样的 fallback：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">circuitbreaker_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://backing-service:8088</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/consumingServiceEndpoint</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CircuitBreaker</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">myCircuitBreaker</span></span><br><span class="line">            <span class="attr">fallbackUri:</span> <span class="string">forward:/inCaseOfFailureUseThis</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RewritePath=/consumingServiceEndpoint,</span> <span class="string">/backingServiceEndpoint</span></span><br></pre></td></tr></table></figure>

<p>下面的代码在 Java 中做了相同的事情：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">routes</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">        .route(<span class="string">"circuitbreaker_route"</span>, r -&gt; r.path(<span class="string">"/consumingServiceEndpoint"</span>)</span><br><span class="line">            .filters(f -&gt; f.circuitBreaker(c -&gt; c.name(<span class="string">"myCircuitBreaker"</span>).fallbackUri(<span class="string">"forward:/inCaseOfFailureUseThis"</span>))</span><br><span class="line">                .rewritePath(<span class="string">"/consumingServiceEndpoint"</span>, <span class="string">"/backingServiceEndpoint"</span>)).uri(<span class="string">"lb://backing-service:8088"</span>)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此示例在调用断路器 fallback 时转发到 /inCaseofFailureUseThis URI。注意，这个示例还演示了 Spring Cloud Netflix Ribbon 负载平衡(可选)(由目标 URI 上的 lb 前缀定义)。</p>
<p>主要的场景是使用 fallbackUri 来定义网关应用程序中的内部控制器或处理程序。但是，我们也可以将请求重新路由到外部应用程序中的控制器或处理程序，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">ingredients</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://ingredients</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=//ingredients/**</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CircuitBreaker</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">fetchIngredients</span></span><br><span class="line">            <span class="attr">fallbackUri:</span> <span class="string">forward:/fallback</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">ingredients-fallback</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:9994</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/fallback</span></span><br></pre></td></tr></table></figure>

<p>在本例中，网关应用程序中没有 fallback endpoint 或 handler。但是，在另一个应用程序中有一个，注册在 localhost:9994 下。</p>
<p>在请求被转发到 fallback 的情况下，此过滤器也提供了导致 fallback 的 Throwable。它作为属性 ServerWebExchangeUtils.CIRCUITBREAKER_EXECUTION_EXCEPTION_ATTR 被添加到 ServerWebExchange 中，可以在处理网关应用程序中的 fallback 时使用。</p>
<h2 id="FallbackHeaders"><a href="#FallbackHeaders" class="headerlink" title="FallbackHeaders"></a>FallbackHeaders</h2><p>此过滤器允许向转发到外部应用程序的 fallbackUri 的请求的 headers 中添加  Hystrix 或 Spring Cloud CircuitBreaker 执行异常细节。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">ingredients</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://ingredients</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=//ingredients/**</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CircuitBreaker</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">fetchIngredients</span></span><br><span class="line">            <span class="attr">fallbackUri:</span> <span class="string">forward:/fallback</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">ingredients-fallback</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:9994</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/fallback</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FallbackHeaders</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">executionExceptionTypeHeaderName:</span> <span class="string">Test-Header</span></span><br></pre></td></tr></table></figure>

<p>在本例中，在运行断路器时发生执行异常后，请求被转发到运行在 localhost:9994 上的应用程序中的 fallback endpoint 或 handler。包含异常类型、消息和根原因异常类型和消息的 headers 由此过滤器添加到该请求。</p>
<p>可以通过设置以下参数的值(与默认值一起显示)来覆盖配置中 header 的名称:</p>
<ul>
<li>executionExceptionTypeHeaderName (“Execution-Exception-Type”)</li>
<li>executionExceptionMessageHeaderName (“Execution-Exception-Message”)</li>
<li>rootCauseExceptionTypeHeaderName (“Root-Cause-Exception-Type”)</li>
<li>rootCauseExceptionMessageHeaderName (“Root-Cause-Exception-Message”)</li>
</ul>
<h2 id="MapRequestHeader"><a href="#MapRequestHeader" class="headerlink" title="MapRequestHeader"></a>MapRequestHeader</h2><p>它创建了一个新的 header(toHeader)，其值是从传入的 http 请求的 header(fromHeader)中提取出来的。如果传入的 header 不存在，则过滤器没有影响。如果新的 header 已经存在，它的值将被新值扩充。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">map_request_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">MapRequestHeader=Blue,</span> <span class="string">X-Request-Red</span></span><br></pre></td></tr></table></figure>

<p>将 X-Request-Red:<values> header 添加到下游请求中，并将其值更新为传入的 HTTP 请求中的 Blue header 的值。</p>
<h2 id="PrefixPath"><a href="#PrefixPath" class="headerlink" title="PrefixPath"></a>PrefixPath</h2><p>接受单个 prefix 参数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">prefixpath_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">PrefixPath=/mypath</span></span><br></pre></td></tr></table></figure>

<p>这将为所有匹配请求的路径加上前缀 /mypath。因此，对 /hello 的请求将被发送到 /mypath/hello。</p>
<h2 id="PreserveHostHeader"><a href="#PreserveHostHeader" class="headerlink" title="PreserveHostHeader"></a>PreserveHostHeader</h2><p>没有参数。此过滤器设置路由过滤器检查的请求属性，以确定是否应该发送原始 host header，而不是由 HTTP 客户端确定的 host header。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">preserve_host_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">PreserveHostHeader</span></span><br></pre></td></tr></table></figure>

<h2 id="RequestRateLimiter"><a href="#RequestRateLimiter" class="headerlink" title="RequestRateLimiter"></a>RequestRateLimiter</h2><p>此过滤器使用一个 RateLimiter 实现来确定当前请求是否被允许继续。如果不是，则返回 HTTP 429 的状态—太多的请求(默认情况下)。</p>
<p>此过滤器接受一个可选的 keyResolver 参数和特定于速率限制器的参数。</p>
<p>keyResolver 是实现 keyResolver 接口的 bean。在配置中，使用 SpEL 按名称引用 bean。#{@myKeyResolver} 是一个 SpEL 表达式，它引用一个名为 myKeyResolver 的 bean。下面的代码显示了 KeyResolver 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyResolver</span> </span>&#123;</span><br><span class="line">    <span class="function">Mono&lt;String&gt; <span class="title">resolve</span><span class="params">(ServerWebExchange exchange)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>KeyResolver 的默认实现是 PrincipalNameKeyResolver，它从 ServerWebExchange 中获取 Principal  并调用 Principal.getname()。</p>
<p>默认情况下，如果 KeyResolver 没有找到 key，请求将被拒绝。可以通过设置 spring.cloud.gateway.filter.request-rate-limiter.deny-empty-key (true or false) 和 spring.cloud.gateway.filter.request-rate-limiter.empty-key-status-code 属性来调整此行为。</p>
<h3 id="Redis-RateLimiter"><a href="#Redis-RateLimiter" class="headerlink" title="Redis RateLimiter"></a>Redis RateLimiter</h3><p>Redis 的实现基于 <a href="https://stripe.com/blog/rate-limiters" target="_blank" rel="noopener">Stripe</a> 完成的工作。它需要使用 spring-boot-starter-data-redis-reactive Spring Boot starter。</p>
<p>使用的算法是<a href="https://en.wikipedia.org/wiki/Token_bucket" target="_blank" rel="noopener">令牌桶算法（Token Bucket Algorithm）</a>。</p>
<ul>
<li><p>redis-rate-limiter.replenishRate 允许用户每秒执行多少请求，而不需要删除任何请求。这是令牌桶被填充的速率。</p>
</li>
<li><p>redis-rate-limiter.burstCapacity 用户在一秒钟内允许执行的最大请求数。这是令牌桶可以容纳的令牌数量。将此值设置为 0 将阻塞所有请求。</p>
</li>
</ul>
<p>一个稳定的速率是通过设置相同的 replenishRate 和 burstCapacity 来实现的。可以通过将 burstCapacity 设置为高于 replenishRate 来允许临时突发。在这种情况下，需要允许速率限制器在突发之间留出一些时间(根据 replenishRate)，因为两个连续的突发将导致请求下降(HTTP 429—请求太多)。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">requestratelimiter_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<p>下面的示例在 Java 中配置一个 KeyResolver：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">KeyResolver <span class="title">userKeyResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> exchange -&gt; Mono.just(exchange.getRequest().getQueryParams().getFirst(<span class="string">"user"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这定义了每个用户的请求速率限制为 10。允许 20 个请求，但是在接下来的一秒内，只有 10 个请求可用。KeyResolver 是一个简单的工具，它获取用户请求参数(注意，不建议在生产环境中使用这个参数)。</p>
<p>我们还可以将速率限制器定义为实现了 RateLimiter 接口的 bean。在配置中，可以使用 SpEL 通过名称引用 bean。#{@myRateLimiter} 是一个 SpEL 表达式，它引用一个名为 myRateLimiter 的 bean。下面的配置定义了一个速率限制器，它使用前面配置中定义的 KeyResolver：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">requestratelimiter_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">rate-limiter:</span> <span class="string">"#&#123;@myRateLimiter&#125;"</span></span><br><span class="line">            <span class="attr">key-resolver:</span> <span class="string">"#&#123;@userKeyResolver&#125;"</span></span><br></pre></td></tr></table></figure>

<h2 id="RedirectTo"><a href="#RedirectTo" class="headerlink" title="RedirectTo"></a>RedirectTo</h2><p>接受两个参数：status 和 url。状态参数应该是 300 系列的重定向 HTTP 代码，比如 301。url 参数应该是一个有效的 url。这是 Location header 的值。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">prefixpath_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RedirectTo=302,</span> <span class="string">https://acme.org</span></span><br></pre></td></tr></table></figure>

<p>这将发送一个 302 状态码来执行重定向，重定向的地址为 <a href="https://acme.org。" target="_blank" rel="noopener">https://acme.org。</a></p>
<h2 id="RemoveHopByHopHeadersFilter"><a href="#RemoveHopByHopHeadersFilter" class="headerlink" title="RemoveHopByHopHeadersFilter"></a>RemoveHopByHopHeadersFilter</h2><p>从转发的请求中移除 headers。</p>
<p>默认移除的 headers 由：</p>
<ul>
<li>Connection</li>
<li>Keep-Alive</li>
<li>Proxy-Authenticate</li>
<li>Proxy-Authorization</li>
<li>TE</li>
<li>Trailer</li>
<li>Transfer-Encoding</li>
<li>Upgrade</li>
</ul>
<p>要更改移除的 headers，可以设置 spring.cloud.gateway.filter.remove-non-proxy-header.headers 属性来指明要删除的 headers 列表。</p>
<h2 id="RemoveRequestHeader"><a href="#RemoveRequestHeader" class="headerlink" title="RemoveRequestHeader"></a>RemoveRequestHeader</h2><p>接受名称参数。它是要删除的 header 的名称。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">removerequestheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RemoveRequestHeader=X-Request-Foo</span></span><br></pre></td></tr></table></figure>

<p>这将在 X-Request-Foo header 被发送到下游之前删除它。</p>
<h2 id="RemoveResponseHeader"><a href="#RemoveResponseHeader" class="headerlink" title="RemoveResponseHeader"></a>RemoveResponseHeader</h2><p>接受名称参数。它是要删除的 header 的名称。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">removeresponseheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RemoveResponseHeader=X-Response-Foo</span></span><br></pre></td></tr></table></figure>

<p>这将在响应返回到网关客户端之前从响应中删除 X-Response-Foo header。</p>
<p>要删除任何类型的敏感标头，我们应该为希望删除的任何 routes 配置这个 filter。此外，还可以使用 spring.cloud.gateway.default-filters 配置此过滤器一次，并将其应用于所有 routes。</p>
<h2 id="RemoveRequestParameter"><a href="#RemoveRequestParameter" class="headerlink" title="RemoveRequestParameter"></a>RemoveRequestParameter</h2><p>接受名称参数。它是要删除的查询参数的名称。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">removerequestparameter_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RemoveRequestParameter=red</span></span><br></pre></td></tr></table></figure>

<p>这将在 red 参数被发送到下游之前删除它。</p>
<h2 id="RewritePath"><a href="#RewritePath" class="headerlink" title="RewritePath"></a>RewritePath</h2><p>接受一个路径 regexp 参数和一个替换参数。它使用 Java 正则表达式以一种灵活的方式重写请求路径。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">rewritepath_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/foo/**</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RewritePath=/red(?&lt;segment&gt;/?.*),</span> <span class="string">$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p>对于 /red/blue 的请求路径，这将在发出下游请求之前将路径设置为 /blue。注意，由于 YAML 规范的原因，应该将 $ 替换为 $\。</p>
<h2 id="RewriteLocationResponseHeader"><a href="#RewriteLocationResponseHeader" class="headerlink" title="RewriteLocationResponseHeader"></a>RewriteLocationResponseHeader</h2><p>修改 Location 响应 header 的值，通常去掉后端特定的细节。它接受 stripVersionMode、locationHeaderName、hostValue 和 protocolsRegex 参数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">rewritelocationresponseheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RewriteLocationResponseHeader=AS_IN_REQUEST,</span> <span class="string">Location,</span> <span class="string">,</span></span><br></pre></td></tr></table></figure>

<p>例如，对于请求 POST api.example.com/some/object/name，object-service.prod.example.net/v2/some/object/id 的 Location 响应 header 被重写为 api.example.com/some/object/id。</p>
<p>stripVersionMode 参数有以下可能的值：NEVER_STRIP、AS_IN_REQUEST(默认值) 和 ALWAYS_STRIP。</p>
<ul>
<li>NEVER_STRIP 即使原始请求路径不包含 version，也不会删除 version。</li>
<li>AS_IN_REQUEST 仅当原始请求路径不包含 version 时，才剥离 version。</li>
<li>ALWAYS_STRIP 即使原始请求路径包含 version，version 也总是被剥离。</li>
</ul>
<p>如果提供了 hostValue 参数，则该参数用于替换响应的 Location header 的 host:port 部分。如果没有提供，则使用 Host request header。</p>
<p>protocolsRegex 参数必须是有效的 regex 字符串，协议名与之匹配。如果不匹配，则筛选器什么也不做。默认是 http|https|ftp|ftps。</p>
<h2 id="RewriteResponseHeader"><a href="#RewriteResponseHeader" class="headerlink" title="RewriteResponseHeader"></a>RewriteResponseHeader</h2><p>接受名称、regexp 和替换参数。它使用 Java 正则表达式以一种灵活的方式重写响应头值。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">rewriteresponseheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RewriteResponseHeader=X-Response-Red,</span> <span class="string">,</span> <span class="string">password=[^&amp;]+,</span> <span class="string">password=***</span></span><br></pre></td></tr></table></figure>

<p>对于 header 值 /42?user=ford&amp;password=omg!what&amp;flag=true，在提出下游请求之后，它被设置为 /42?user=ford&amp;password=***&amp;flag=true。根据 YAML 规范，必须使用 $\ 表示 $。</p>
<h2 id="SaveSession"><a href="#SaveSession" class="headerlink" title="SaveSession"></a>SaveSession</h2><p>将调用转发到下游之前，强制执行 WebSession::save 操作。这在使用带有惰性数据存储的 Spring Session 之类的技术时特别有用，我们需要确保在进行转发调用之前保存了会话状态。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">save_session</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/foo/**</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SaveSession</span></span><br></pre></td></tr></table></figure>

<p>如果我们将 Spring Security 与 Spring Session 集成，并希望确保安全细节已被转发到远程进程，这是非常重要的。</p>
<h2 id="SecureHeaders"><a href="#SecureHeaders" class="headerlink" title="SecureHeaders"></a>SecureHeaders</h2><p>SecureHeaders 在响应中添加了许多 headers。</p>
<ul>
<li>X-Xss-Protection:1 (mode=block)</li>
<li>Strict-Transport-Security (max-age=631138519)</li>
<li>X-Frame-Options (DENY)</li>
<li>X-Content-Type-Options (nosniff)</li>
<li>Referrer-Policy (no-referrer)</li>
<li>Content-Security-Policy (default-src ‘self’ https:; font-src ‘self’ https: data:; img-src ‘self’ https: data:; object-src ‘none’; script-src https:; style-src ‘self’ https: ‘unsafe-inline)’</li>
<li>X-Download-Options (noopen)</li>
<li>X-Permitted-Cross-Domain-Policies (none)</li>
</ul>
<p>要更改默认值，请在 spring.cloud.gateway.filter.secure-headers 命名空间中设置适当的属性。</p>
<p>要禁用默认值，请设置 spring.cloud.gateway.filter.secure-headers.disable 属性，属性值由逗号分隔值。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.cloud.gateway.filter.secure-headers.disable:</span> <span class="string">x-frame-options,strict-transport-security</span></span><br></pre></td></tr></table></figure>

<h2 id="SetPath"><a href="#SetPath" class="headerlink" title="SetPath"></a>SetPath</h2><p>接受一个路径模板参数。它提供了一种通过允许模板化路径片段来操作请求路径的简单方法。它使用来自 Spring Framework 的 URI 模板。允许多个匹配段。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setpath_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/red/&#123;segment&#125;</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetPath=/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p>对于 /red/blue 的请求路径，这将在发出下游请求之前将路径设置为 /blue。</p>
<h2 id="SetRequestHeader"><a href="#SetRequestHeader" class="headerlink" title="SetRequestHeader"></a>SetRequestHeader</h2><p>接受名称和值参数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setrequestheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetRequestHeader=X-Request-Red,</span> <span class="string">Blue</span></span><br></pre></td></tr></table></figure>

<p>此过滤器使用给定名称替换(而不是添加)所有 headers。因此，如果下游服务器响应一个 X-Request-Red:1234，这将被替换为 X-Request-Red:Blue，这是下游服务将接收的内容。</p>
<p>SetRequestHeader 知道用于匹配路径或 host 的 URI 变量。URI 变量可以在值中使用，并在运行时展开。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setrequestheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Host:</span> <span class="string">&#123;segment&#125;.myhost.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetRequestHeader=foo,</span> <span class="string">bar-&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="SetResponseHeader"><a href="#SetResponseHeader" class="headerlink" title="SetResponseHeader"></a>SetResponseHeader</h2><p>接受名称和值参数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setresponseheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetResponseHeader=X-Response-Red,</span> <span class="string">Blue</span></span><br></pre></td></tr></table></figure>

<p>此过滤器使用给定名称替换(而不是添加)所有 headers。因此，如果下游服务器响应一个 X-Response-Red:1234，这将被替换为 X-Response-Red:Blue，这是网关客户端将接收到的内容。</p>
<p>SetResponseHeader知道用于匹配路径或主机的URI变量 知道用于匹配路径或 host 的 URI 变量。URI 变量可以在值中使用，并在运行时展开。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setresponseheader_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Host:</span> <span class="string">&#123;segment&#125;.myhost.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetResponseHeader=foo,</span> <span class="string">bar-&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="SetStatus"><a href="#SetStatus" class="headerlink" title="SetStatus"></a>SetStatus</h2><p>接受单个参数 status。它必须是一个有效的 Spring HttpStatus。它可以是整数值 404 或枚举的字符串表示形式：NOT_FOUND。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setstatusstring_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetStatus=BAD_REQUEST</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">setstatusint_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SetStatus=401</span></span><br></pre></td></tr></table></figure>

<p>在这两种情况下，响应的 HTTP 状态都设置为 401。</p>
<p>我们可以配置 SetStatus GatewayFilter，以在响应的 header 中返回代理请求的原始 HTTP 状态代码。如果配置了以下属性，header 将添加到响应：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">set-status:</span></span><br><span class="line">        <span class="attr">original-status-header-name:</span> <span class="string">original-http-status</span></span><br></pre></td></tr></table></figure>

<h2 id="StripPrefix"><a href="#StripPrefix" class="headerlink" title="StripPrefix"></a>StripPrefix</h2><p>接受一个参数 parts。parts 参数表示在将请求发送到下游之前，从请求中剥离的路径中的部件数。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">nameRoot</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://nameservice</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/name/**</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">StripPrefix=2</span></span><br></pre></td></tr></table></figure>

<p>当通过网关向 /name/blue/red 发出请求时，向 nameservice 发出的请求看起来就像 nameservice/red。</p>
<h2 id="Retry"><a href="#Retry" class="headerlink" title="Retry"></a>Retry</h2><p>支持以下参数:</p>
<ul>
<li>retries 应该尝试的重试次数。默认 3 次。</li>
<li>statuses 应该重试的 HTTP 状态代码，用 org.springframework.http.HttpStatus 表示。</li>
<li>methods 应该重试的 HTTP 方法，用 org.springframework.http.HttpMethod 表示。默认 GET。</li>
<li>series 重试状态码的序列，用 org.springframework.http.HttpStatus.Series 表示。默认 5XX series。</li>
<li>exceptions 应该重试的抛出异常的列表。默认 IOException 和 TimeoutException。</li>
<li>backoff 为重试配置的指数后退。在 firstBackoff * (factor ^ n) 的回退间隔后执行重试，其中 n 为迭代。如果配置了 maxBackoff，则应用的最大 backoff 限制为 maxBackoff。如果 basedOnPreviousValue 为 true，则使用 prevBackoff * 因子计算回退。默认 disabled。</li>
</ul>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">retry_test</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8080/flakey</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Host=*.retry.com</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Retry</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">statuses:</span> <span class="string">BAD_GATEWAY</span></span><br><span class="line">            <span class="attr">backoff:</span></span><br><span class="line">              <span class="attr">firstBackoff:</span> <span class="string">10ms</span></span><br><span class="line">              <span class="attr">maxBackoff:</span> <span class="string">50ms</span></span><br><span class="line">              <span class="attr">factor:</span> <span class="number">2</span></span><br><span class="line">              <span class="attr">basedOnPreviousValue:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="RequestSize"><a href="#RequestSize" class="headerlink" title="RequestSize"></a>RequestSize</h2><p>当请求大小大于允许的限制时，此过滤器可以限制请求到达下游服务。接受RequestSize参数。它是以字节为单位定义的请求的允许大小限制。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">request_size_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:8080/upload</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/upload</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestSize</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="attr">maxSize:</span> <span class="number">5000000</span></span><br></pre></td></tr></table></figure>

<p>此过滤器将响应状态设置为 413 负载太大，并在请求因大小而被拒绝时附加一个header errorMessage。下面的例子显示了这样一个错误消息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errorMessage&#96; : &#96;Request size is larger than permissible limit. Request size is 6.0 MB where permissible limit is 5.0 MB</span><br></pre></td></tr></table></figure>

<p>如果路由定义中没有提供过滤器参数，则默认请求大小设置为 5mb。</p>
<h2 id="Default-Filters"><a href="#Default-Filters" class="headerlink" title="Default Filters"></a>Default Filters</h2><p>要添加一个过滤器并将其应用于所有 routes，我们可以使用 spring.cloud.gateway.default-filters。此属性接受 filters 列表。示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Default-Red,</span> <span class="string">Default-Blue</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PrefixPath=/httpbin</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">Spring Cloud Gateway</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">晴天</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">199</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">晴天</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
