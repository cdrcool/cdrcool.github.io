---
title: Redis 缓存穿透 & 缓存击穿 & 缓存雪崩
date: 2020-02-19 16:48:00
categories: Redis
---
## 缓存穿透
### 描述
缓存穿透是指缓存和数据库中都没有数据，而用户却不断在发起请求，如查找 id 为 -1 或特别大等不存在的的数据。这时的用户很可能是攻击者，攻击会导致数据库压力过大。

### 解决方案
1. 接口层增加校验，如用户鉴权校验，id 做基础校验，id <= 的直接拦截。
2. 对于缓存和数据库中都取不到的数据，可以将对应 key 的 value 设置为 null，同时设置 key 的过期时间，过期时间可以设置断点，如 30 秒，设置过长会导致正常情况下也查找不到数据。
3. 使用布隆过滤器，将所有可能存在的数据哈希到一个足够大的 bitmap 中，一个一定不存在的数据会被这个 bitmap 拦截掉，从而避免了对底层存储系统的查询压力。

## 缓存击穿
### 描述
缓存击穿是指缓存中没有但数据库中有数据（一般是缓存时间到期），这时由于并发用户特别多，同时读缓存没有读到数据，又同时去数据库中查找数据，引起数据库压力瞬间增大，造成过大压力。

### 解决方案
1. 设置热点数据永不过期。
2. 增加互斥锁，参考代码如下：

![互斥锁示例](/images/redis/互斥锁示例.png)

说明：
1) 缓存中有数据，直接走上述代码 13 行后就返回结果了；
2) 缓存中没有数据，第 1 个进入的线程，获取锁并从数据库去取数据，没释放锁之前，其他并行进入的线程会等待 100ms，再重新去缓存取数据。这样就防止都去数据库重复取数据，重复往缓存中更新数据情况出现。
3) 当然这是简化处理，理论上如果能根据 key 值加锁就更好了，就是线程 A 从数据库取 key1 的数据并不妨碍线程 B 取 key2 的数据，上面代码明显做不到这点。

## 缓存雪崩
### 描述
缓存雪崩是值缓存中数据大批量到了过期时间，而查询数据量巨大，引起数据库压力过大甚至宕机。与缓存击穿不同的是缓存击穿是并发查找同一条数据，缓存雪崩是并发查找大量数据。

### 解决方案
1. 设置热点数据永远不过期。
2. 缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生。
3. 如果缓存数据库是分布式部署，将热点数据均匀分布在不同的缓存数据库中。
4. 缓存标记：记录缓存数据是否过期，如果过期会触发通知另外的线程在后台去更新实际 key 的缓存。

## 参考资料
1. [缓存穿透、缓存击穿、缓存雪崩区别和解决方案](https://blog.csdn.net/kongtiao5/article/details/82771694)
2. [REDIS缓存穿透，缓存击穿，缓存雪崩原因+解决方案](https://www.cnblogs.com/xichji/p/11286443.html)