---
title: 第三方开放平台登录授权设计与实现
date: 2020-05-06 15:00:00
categories: 架构设计
---
# 数据表设计
## 公司信息表
| 字段名 | 字段描述 |
| :--- | :--- |
| id | 主键 |
| company_name | 公司名称 |
| taxpayer_id | 纳税人识别号 |
| company_phone | 公司电话 |
| company_registered_address | 公司注册地址 |
| bank_name | 开户行名称 |
| bank_account | 开户行账号 |
| jd_account | 京东账号名 |
| sn_account | 苏宁账号名 |

##第三方账号表
| 字段名 | 字段描述 |
| :--- | :--- |
| id | 主键 |
| account_type | 账号类型（jd-京东；sn-苏宁） |
| account | 账号名 |
| password | 账号密码 |
| access_token | 访问令牌 |
| refresh_token | 刷新令牌 |
| access_token_expires_at | 访问令牌过期时间 |
| refresh_token_expires_at | 刷新令牌过期时间 |
| sn_account | 苏宁账号名 |

# 接口设计
## 请求第三方token
请求地址：POST /{accountType}-account/request-access-token

请求参数：

| 参数名 | 参数描述 |
| :--- | :--- |
| taxpayerId | 纳税人识别号 |
| timeout | 超时时间（单位：秒），默认值 3 |

如果未传递 taxpayerId，则请求默认的第三方token；如果在指定时间内，第三方未返回token，则抛出错误提示：请求第三方token超时。

请求响应：token字符串

## 第三方回调地址
调用请求第三方token接口后，由第三方回调该接口。

请求地址：GET /{accountType}-account/callback-token

请求参数：

| 参数名 | 参数描述 |
| :--- | :--- |
| code | 第三方返回的鉴权码 |
| state | 由client使用的不透明参数，用于请求阶段和回调阶段之间的状态保持 |

请求响应：token字符串

## 刷新第三方token
请求地址：POST /{accountType}-account/refresh-token

请求参数：

| 参数名 | 参数描述 |
| :--- | :--- |
| taxpayerId | 纳税人识别号 |

如果未传递 taxpayerId，则请求默认的第三方token。

请求响应：token字符串

## 获取第三方token
请求地址：POST /{accountType}-account/get-access-token

请求参数：

| 参数名 | 参数描述 |
| :--- | :--- |
| taxpayerId | 纳税人识别号 |
| timeout | 超时时间（单位：秒），默认值 3 |

如果未传递 taxpayerId，则请求默认的第三方token；如果在指定时间内，未返回第三方token，则抛出错误提示：获取第三方token超时。

请求响应：token字符串

## 初始化所有的第三方token
请求地址：POST /{accountType}-account/init-all-token

## 刷新所有的第三方token
请求地址：POST /{accountType}-account/refresh-all-token

# 接口实现UML类图
![接口实现UML类图](/images/第三方登录授权接口实现UML类图.png)

* ThirdAccountController：第三方账号 Controller 抽象类
* JdAccountController：京东账号 Controller 实现类，注入京东账号 Service
* SnAccountController：苏宁账号 Controller 实现类，注入苏宁账号 Service
* ThirdAccountService：第三方账号 Service 抽象类
* JdAccountService：京东账号 Service 实现类
* SnAccountService：苏宁账号 Service 实现类




