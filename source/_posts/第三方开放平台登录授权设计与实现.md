---
title: 第三方开放平台登录授权设计与实现
date: 2020-05-06 15:00:00
categories: 架构设计
---
# 数据表设计
## 公司信息表
| 字段名 | 字段描述 |
| :--- | :--- |
| id | 主键 |
| company_name | 公司名称 |
| taxpayer_id | 纳税人识别号 |
| company_phone | 公司电话 |
| company_registered_address | 公司注册地址 |
| bank_name | 开户行名称 |
| bank_account | 开户行账号 |
| jd_account | 京东账号名 |
| sn_account | 苏宁账号名 |

## 第三方账号表
| 字段名 | 字段描述 |
| :--- | :--- |
| id | 主键 |
| account_type | 账号类型（jd-京东；sn-苏宁） |
| account | 账号名 |
| password | 账号密码 |
| access_token | 访问令牌 |
| refresh_token | 刷新令牌 |
| access_token_expires_at | 访问令牌过期时间 |
| refresh_token_expires_at | 刷新令牌过期时间 |
| sn_account | 苏宁账号名 |

在第三方账号表里的账号，都是子账号，总账号信息保存在配置文件中（也可以保存在数据库里），如下：
```yaml
sdk:
  accounts:
    jd:
      auth-url:
      server-url:
      account: 
      password:
      app-key:
      app-secret:
      redirect-uri:
      rsa-key:
    sn:
      auth-url:
      server-url:
      account:
      password:
      app-key:
      app-secret:
      redirect-uri:
      rsa-key:
```
除了账号名和账号密码之外，其他信息子账号与主账号相同。

# 接口设计
## 请求第三方token
**请求地址**：POST /{account-type}-account/request-access-token

**请求参数**：

| 参数名 | 参数描述 |
| :--- | :--- |
| taxpayerId | 纳税人识别号 |
| timeout | 超时时间（单位：秒），默认值 3 |

如果未传递 taxpayerId，则请求默认的第三方token；如果在指定时间内，第三方未返回token，则抛出错误提示：请求第三方token超时。

**请求响应**：token字符串

## 第三方回调地址
调用请求第三方token接口后，由第三方回调该接口。

**请求地址**：GET /{account-type}-account/callback-token

**请求参数**：

| 参数名 | 参数描述 |
| :--- | :--- |
| code | 第三方返回的鉴权码 |
| state | 由client使用的不透明参数，用于请求阶段和回调阶段之间的状态保持 |

**请求响应**：token字符串

## 刷新第三方token
**请求地址**：POST /{account-type}-account/refresh-token

**请求参数**：

| 参数名 | 参数描述 |
| :--- | :--- |
| taxpayerId | 纳税人识别号 |

如果未传递 taxpayerId，则请求默认的第三方token。

**请求响应**：token字符串

## 获取第三方token
**请求地址**：POST /{account-type}-account/get-access-token

**请求参数**：

| 参数名 | 参数描述 |
| :--- | :--- |
| taxpayerId | 纳税人识别号 |
| timeout | 超时时间（单位：秒），默认值 3 |

如果未传递 taxpayerId，则请求默认的第三方token；如果在指定时间内，未返回第三方token，则抛出错误提示：获取第三方token超时。

**请求响应**：token字符串

## 初始化所有的第三方token
**请求地址**：POST /{account-type}-account/init-all-token

## 刷新所有的第三方token
**请求地址**：POST /{account-type}-account/refresh-all-token

# 接口实现-UML类图
![接口实现UML类图](/images/architecture/第三方登录授权接口实现UML类图.png)

* ThirdAccountController：第三方账号 Controller 抽象类
* JdAccountController：京东账号 Controller 实现类，注入京东账号 Service
* SnAccountController：苏宁账号 Controller 实现类，注入苏宁账号 Service
* ThirdAccountService：第三方账号 Service 抽象类
* JdAccountService：京东账号 Service 实现类
* SnAccountService：苏宁账号 Service 实现类

# Token 请求流程
![第三方token请求流程](/images/architecture/第三方token请求流程.png)

# Token 定时刷新
```java
/**
 * 第三方token刷新定时任务
 *
 * @author cdrcool
 */
@Slf4j
@Component
public class ThirdTokenRefreshTask {
    private final Map<String, ThirdAccountService> thirdAccountServices;

    public ThirdTokenRefreshTask(Map<String, ThirdAccountService> thirdAccountServices) {
        this.thirdAccountServices = thirdAccountServices;
    }

    @Scheduled(cron = "${sdk.accounts.refresh-token-cron}")
    public void execute() {
        thirdAccountServices.values().forEach(thirdAccountService -> {
            try {
                thirdAccountService.refreshAllToken();
            } catch (Exception e) {
                log.error("定时刷新第三方token异常，class name：{}", thirdAccountService.getClass().getSimpleName());
            }
        });
    }
}
```
```yaml
sdk:
  accounts:
    refresh-token-cron: 0 0 0 * * ?
```




